<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>–®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂ ¬∑ –∑–∞–∫–∞–∑</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* –≤—Å–µ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äì –æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö */
        :root {
            --bg: #000000;
            --surface: #1c1c1e;
            --surface-2: #2c2c2e;
            --surface-3: #3a3a3c;
            --border: #38383a;
            --border-hover: #48484a;
            --primary: #0a84ff;
            --primary-hover: #0071e3;
            --primary-glow: rgba(10, 132, 255, 0.15);
            --primary-soft: rgba(10, 132, 255, 0.1);
            --danger: #ff453a;
            --danger-soft: rgba(255, 69, 58, 0.15);
            --success: #30d158;
            --success-soft: rgba(48, 209, 88, 0.15);
            --text: #f5f5f7;
            --text-secondary: #98989d;
            --text-muted: #636366;
            --radius-sm: 10px;
            --radius: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --shadow: 0 4px 24px rgba(0,0,0,0.4);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.6);
            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            max-width: 520px;
            margin: 0 auto;
            padding: 12px;
            padding-top: calc(env(safe-area-inset-top, 0px) + 12px);
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
        }

        .header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 20px;
            padding: 18px;
            background: var(--surface);
            border-radius: var(--radius-xl);
        }

        .header-icon {
            width: 46px; height: 46px;
            background: linear-gradient(135deg, #0a84ff, #5e5ce6);
            border-radius: 13px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; color: white; flex-shrink: 0;
            cursor: pointer;
        }

        .header h1 { 
            font-size: 1.4rem; 
            font-weight: 700; 
            letter-spacing: -0.3px; 
            line-height: 1.2; 
            flex: 1;
        }
        .header-sub { font-size: 0.82rem; color: var(--text-secondary); margin-top: 2px; }

        .header-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .icon-btn {
            width: 40px; height: 40px;
            background: var(--surface-2);
            border: none;
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition);
            flex-shrink: 0;
        }
        .icon-btn:active { background: var(--surface-3); color: var(--primary); transform: scale(0.92); }

        .card-group {
            background: var(--surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 6px;
        }

        .card {
            display: flex; align-items: center;
            padding: 14px 16px;
            cursor: pointer;
            transition: background var(--transition);
            min-height: 56px;
        }

        .card:active { background: var(--surface-2); }
        .card + .card { border-top: 0.5px solid var(--border); }

        .card-icon {
            width: 32px; height: 32px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.85rem; color: white; flex-shrink: 0; margin-right: 12px;
        }

        .card-icon.blue { background: #0a84ff; }
        .card-icon.orange { background: #ff9f0a; }
        .card-icon.green { background: #30d158; }
        .card-icon.purple { background: #bf5af2; }
        .card-icon.red { background: #ff453a; }

        .card-content { flex: 1; min-width: 0; }
        .card-title { font-size: 0.95rem; font-weight: 500; color: var(--text); line-height: 1.3; }

        .card-subtitle {
            font-size: 0.8rem; color: var(--text-secondary);
            margin-top: 2px; line-height: 1.3;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        .card-subtitle.has-tags {
            white-space: normal; display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;
        }

        .mini-tag {
            display: inline-flex; align-items: center; gap: 3px;
            background: var(--surface-2); padding: 2px 8px; border-radius: 20px;
            font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap;
        }

        .mini-tag .cnt {
            background: var(--primary-soft); color: var(--primary);
            font-weight: 700; padding: 0 5px; border-radius: 8px; font-size: 0.7rem;
        }

        .card-chevron { color: var(--text-muted); font-size: 0.75rem; margin-left: 8px; flex-shrink: 0; }

        .footer-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 15px; border-radius: var(--radius); border: none;
            font-size: 0.95rem; font-weight: 600; cursor: pointer;
            text-align: center; transition: all var(--transition);
            display: flex; align-items: center; justify-content: center;
            gap: 8px; font-family: inherit;
        }

        .btn:active { transform: scale(0.97); }

        .btn-reset { background: var(--surface); color: var(--text-secondary); }
        .btn-reset:active { background: var(--surface-2); }

        .btn-submit { background: var(--primary); color: white; flex-direction: column; gap: 2px; }
        .btn-submit:active { background: var(--primary-hover); }

        .btn-submit-main {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.95rem; font-weight: 600;
        }

        .btn-submit-sum {
            font-size: 0.78rem; font-weight: 500; opacity: 0.8;
        }

        /* MODAL base */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 1000;
            display: flex; align-items: flex-end; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--surface);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            width: 100%; max-width: 520px;
            max-height: 92vh; max-height: 92dvh;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .modal-overlay.active .modal { transform: translateY(0); }

        .modal-handle {
            width: 36px; height: 5px; background: var(--surface-3);
            border-radius: 3px; margin: 8px auto 0; flex-shrink: 0;
        }

        .modal-head {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 20px 10px; flex-shrink: 0;
        }

        .modal-head h2 {
            font-size: 1.15rem; font-weight: 700;
            display: flex; align-items: center; gap: 8px;
        }

        .modal-head h2 i { color: var(--primary); font-size: 1rem; }

        .modal-close-btn {
            width: 32px; height: 32px; border-radius: 50%; border: none;
            background: var(--surface-3); color: var(--text-secondary);
            font-size: 0.85rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all var(--transition);
        }

        .modal-close-btn:active { background: var(--border-hover); transform: scale(0.9); }

        .modal-body {
            flex: 1; overflow-y: auto; padding: 0 16px 16px;
            overscroll-behavior: contain; -webkit-overflow-scrolling: touch;
        }

        .modal-footer {
            padding: 10px 16px;
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
            border-top: 0.5px solid var(--border);
            flex-shrink: 0;
            display: flex;
            gap: 8px;
        }

        .modal-footer .btn-done {
            flex: 1;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .modal-footer .btn-done:active { background: var(--primary-hover); transform: scale(0.98); }

        .modal-footer .btn-secondary {
            flex: 1;
            padding: 12px;
            background: var(--surface-2);
            color: var(--text-secondary);
            border: none;
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .modal-footer .btn-secondary:active { background: var(--surface-3); transform: scale(0.98); }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –Ω–∞ —Ñ–æ—Ä–º–µ –∫–ª–∏–µ–Ω—Ç–∞ */
        .field-input {
            width: 100%;
            background: var(--surface-2);
            border: none;
            border-radius: var(--radius);
            padding: 13px 14px;
            font-size: 1rem;
            color: var(--text);
            outline: none;
            transition: box-shadow var(--transition);
            font-family: inherit;
        }

        .field-input:focus {
            box-shadow: 0 0 0 3px var(--primary-glow), inset 0 0 0 1px var(--primary);
        }

        .field-input::placeholder {
            color: var(--text-muted);
        }

        .field-label {
            font-size: 0.78rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            padding-left: 4px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤ */
        .history-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            padding: 0 4px;
        }
        .filter-btn {
            flex: 1;
            padding: 8px;
            background: var(--surface-2);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }
        .filter-btn.active {
            background: var(--primary);
            color: white;
        }
        .filter-btn:active { transform: scale(0.95); }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .history-item {
            background: var(--surface-2);
            border-radius: var(--radius);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .history-item-paid {
            width: 28px; height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        .history-item-paid.paid {
            background: var(--success-soft);
            color: var(--success);
        }
        .history-item-paid.unpaid {
            background: var(--danger-soft);
            color: var(--danger);
        }
        .history-item-content {
            flex: 1;
        }
        .history-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .history-item-number {
            font-weight: 700;
            color: var(--primary);
        }
        .history-item-date {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .history-item-client {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }
        .history-item-mechanics {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        .history-item-amount {
            font-weight: 700;
            color: var(--text);
            font-size: 0.95rem;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* settings specific styles */
        .settings-section {
            margin-bottom: 24px;
        }
        .settings-section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .settings-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .settings-item input, .settings-item select {
            background: var(--surface-2);
            border: none;
            border-radius: var(--radius-sm);
            padding: 8px 10px;
            font-size: 0.85rem;
            color: var(--text);
            font-family: inherit;
        }
        .settings-item input:focus, .settings-item select:focus {
            box-shadow: 0 0 0 2px var(--primary-glow), inset 0 0 0 1px var(--primary);
            outline: none;
        }
        .settings-item .svc-name { flex: 2; min-width: 140px; }
        .settings-item .svc-price { width: 70px; }
        .settings-item .svc-radius { width: 80px; }
        .settings-item .svc-car-type { width: 100px; }
        .settings-item .svc-flag { width: 80px; }
        .settings-delete {
            width: 36px; height: 36px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        .settings-delete:active {
            background: var(--danger-soft);
            color: var(--danger);
        }
        .settings-add-btn {
            background: var(--surface-2);
            border: none;
            border-radius: var(--radius-sm);
            padding: 10px;
            color: var(--primary);
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            margin-top: 6px;
            cursor: pointer;
        }
        .settings-add-btn:active {
            background: var(--surface-3);
        }
        .settings-reset-defaults {
            background: transparent;
            border: 0.5px dashed var(--border);
            border-radius: var(--radius-sm);
            padding: 12px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 16px;
            cursor: pointer;
        }
        .settings-reset-defaults:active {
            background: var(--surface-2);
        }

        .modal-footer-sum {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 4px 6px;
        }
        .modal-footer-sum-label {
            font-size: 0.82rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .modal-footer-sum-value {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--success);
        }

        /* other styles */
        .mech-list { display: flex; flex-direction: column; background: var(--surface-2); border-radius: var(--radius); overflow: hidden; }
        .mech-item { display: flex; align-items: center; gap: 12px; padding: 13px 14px; cursor: pointer; transition: background var(--transition); user-select: none; }
        .mech-item + .mech-item { border-top: 0.5px solid var(--border); }
        .mech-item:active { background: var(--surface-3); }
        .mech-check { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--text-muted); display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all var(--transition); font-size: 0.65rem; color: transparent; }
        .mech-item.selected .mech-check { background: var(--primary); border-color: var(--primary); color: white; }
        .mech-name { font-weight: 500; font-size: 0.95rem; }

        .radius-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 16px; }
        .radius-btn { padding: 12px 0; border-radius: var(--radius); border: none; background: var(--surface-2); color: var(--text); font-size: 1rem; font-weight: 600; cursor: pointer; text-align: center; transition: all var(--transition); }
        .radius-btn:active { transform: scale(0.94); }
        .radius-btn.active { background: var(--primary); color: white; }

        .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 16px; }
        .type-btn { padding: 12px 10px; border-radius: var(--radius); border: none; background: var(--surface-2); color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; cursor: pointer; text-align: center; transition: all var(--transition); display: flex; align-items: center; justify-content: center; gap: 6px; }
        .type-btn:active { transform: scale(0.96); }
        .type-btn.active { background: var(--primary-soft); color: var(--primary); }

        .qty-row { display: flex; align-items: center; justify-content: space-between; background: var(--surface-2); border-radius: var(--radius); padding: 10px 14px; margin-bottom: 12px; }
        .qty-row-label { font-weight: 600; font-size: 0.9rem; color: var(--text); display: flex; align-items: center; gap: 8px; }
        .qty-stepper { display: flex; align-items: center; background: var(--surface-3); border-radius: 10px; overflow: hidden; }
        .qty-stepper button { width: 38px; height: 38px; border: none; background: transparent; color: var(--primary); font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background var(--transition); }
        .qty-stepper button:active { background: var(--primary-soft); }
        .qty-stepper .qty-val { width: 40px; text-align: center; font-size: 1.1rem; font-weight: 700; color: var(--text); }

        .apply-all-bar { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--primary-soft); border-radius: var(--radius); cursor: pointer; transition: all var(--transition); }
        .apply-all-bar:active { transform: scale(0.98); opacity: 0.8; }

        .items-list { display: flex; flex-direction: column; background: var(--surface-2); border-radius: var(--radius); overflow: hidden; }
        .item-row { display: flex; align-items: center; padding: 10px 14px; transition: opacity var(--transition); gap: 10px; }
        .item-row + .item-row { border-top: 0.5px solid var(--border); }
        .item-row.zero { opacity: 0.3; }
        .item-name-block { flex: 1; min-width: 0; }
        .item-name { font-weight: 500; font-size: 0.88rem; color: var(--text); line-height: 1.3; }
        .item-price-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 1px; }
        .item-controls { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .item-select-wrap { position: relative; flex-shrink: 0; }
        .item-select { appearance: none; -webkit-appearance: none; background: var(--surface-3); color: var(--primary); border: none; border-radius: 8px; padding: 6px 28px 6px 10px; font-size: 0.95rem; font-weight: 700; font-family: inherit; cursor: pointer; outline: none; min-width: 58px; text-align: center; }
        .item-select-arrow { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.6rem; color: var(--text-muted); pointer-events: none; }
        .item-delete { width: 32px; height: 32px; border: none; background: transparent; color: var(--text-muted); font-size: 0.8rem; cursor: pointer; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all var(--transition); }
        .item-delete:active { color: var(--danger); background: var(--danger-soft); }

        .toast { position: fixed; top: calc(env(safe-area-inset-top, 0px) + 16px); left: 50%; transform: translateX(-50%) translateY(-80px); background: var(--surface-2); color: var(--text); padding: 13px 22px; border-radius: var(--radius-xl); box-shadow: var(--shadow-lg); z-index: 2000; opacity: 0; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 0.9rem; white-space: nowrap; backdrop-filter: blur(20px); border: 0.5px solid var(--border); }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        .confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(20px); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 40px; opacity: 0; visibility: hidden; transition: all 0.25s ease; }
        .confirm-overlay.active { opacity: 1; visibility: visible; }
        .confirm-dialog { background: var(--surface-2); border-radius: 14px; width: 100%; max-width: 300px; text-align: center; overflow: hidden; transform: scale(0.9); transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1); }
        .confirm-overlay.active .confirm-dialog { transform: scale(1); }
        .confirm-body { padding: 22px 20px 16px; }
        .confirm-title { font-size: 1.05rem; font-weight: 700; margin-bottom: 8px; }
        .confirm-text { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4; white-space: pre-line; }
        .confirm-actions { border-top: 0.5px solid var(--border); display: flex; }
        .confirm-actions button { flex: 1; padding: 14px; border: none; background: transparent; font-size: 1rem; font-family: inherit; cursor: pointer; transition: background var(--transition); }
        .confirm-actions button:active { background: var(--surface-3); }
        .confirm-actions .confirm-cancel { color: var(--primary); font-weight: 400; border-right: 0.5px solid var(--border); }
        .confirm-actions .confirm-ok { color: var(--primary); font-weight: 700; }

        @media (min-width: 520px) {
            .modal { border-radius: var(--radius-xl); margin: auto; max-height: 85vh; }
            .modal-overlay { align-items: center; padding: 20px; }
        }
    </style>
</head>
<body>
<div class="app">
    <div class="header">
        <div class="header-icon" id="btnSettings">
            <i class="fa-solid fa-gear"></i>
        </div>
        <div>
            <h1>–®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂</h1>
            <div class="header-sub">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</div>
        </div>
        <div class="header-actions">
            <button class="icon-btn" id="btnHistory" title="–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤">
                <i class="fa-solid fa-clock-rotate-left"></i>
            </button>
        </div>
    </div>

    <!-- main cards -->
    <div class="card-group">
        <div class="card" data-modal="mechanics">
            <div class="card-icon blue"><i class="fa-solid fa-users"></i></div>
            <div class="card-content">
                <div class="card-title">–ú–µ—Ö–∞–Ω–∏–∫–∏</div>
                <div class="card-subtitle" id="dMechanics">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ö–∞–Ω–∏–∫–æ–≤</div>
            </div>
            <span class="card-chevron"><i class="fa-solid fa-chevron-right"></i></span>
        </div>
        <div class="card" data-modal="client">
            <div class="card-icon orange"><i class="fa-solid fa-user"></i></div>
            <div class="card-content">
                <div class="card-title">–ö–ª–∏–µ–Ω—Ç</div>
                <div class="card-subtitle" id="dClient">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</div>
            </div>
            <span class="card-chevron"><i class="fa-solid fa-chevron-right"></i></span>
        </div>
    </div>
    <div class="card-group">
        <div class="card" data-modal="wheels">
            <div class="card-icon green"><i class="fa-solid fa-circle-dot"></i></div>
            <div class="card-content">
                <div class="card-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–ª—ë—Å</div>
                <div class="card-subtitle" id="dWheels">–ù–µ –≤—ã–±—Ä–∞–Ω—ã</div>
            </div>
            <span class="card-chevron"><i class="fa-solid fa-chevron-right"></i></span>
        </div>
    </div>
    <div class="card-group">
        <div class="card" data-modal="materials">
            <div class="card-icon purple"><i class="fa-solid fa-box-open"></i></div>
            <div class="card-content">
                <div class="card-title">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</div>
                <div class="card-subtitle" id="dMaterials">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</div>
            </div>
            <span class="card-chevron"><i class="fa-solid fa-chevron-right"></i></span>
        </div>
        <div class="card" data-modal="services">
            <div class="card-icon red"><i class="fa-solid fa-wrench"></i></div>
            <div class="card-content">
                <div class="card-title">–£—Å–ª—É–≥–∏</div>
                <div class="card-subtitle" id="dServices">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</div>
            </div>
            <span class="card-chevron"><i class="fa-solid fa-chevron-right"></i></span>
        </div>
    </div>
    <div class="footer-actions">
        <button class="btn btn-reset" id="btnReset"><i class="fa-solid fa-rotate-left"></i> –°–±—Ä–æ—Å–∏—Ç—å</button>
        <button class="btn btn-submit" id="btnCreateOrder">
            <span class="btn-submit-main"><i class="fa-solid fa-check"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</span>
            <span class="btn-submit-sum" id="btnSaveSum"></span>
        </button>
    </div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="mMechanics">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-head">
            <h2><i class="fa-solid fa-users"></i> –ú–µ—Ö–∞–Ω–∏–∫–∏</h2>
            <button class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <div class="mech-list" id="mechList"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-done"><i class="fa-solid fa-check"></i> –ì–æ—Ç–æ–≤–æ</button>
        </div>
    </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –ö–õ–ò–ï–ù–¢–ê –° –ö–ê–ú–ï–†–û–ô -->
<div class="modal-overlay" id="mClient">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-head">
            <h2><i class="fa-solid fa-user"></i> –ö–ª–∏–µ–Ω—Ç</h2>
            <button class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <div class="field">
                <div class="field-label" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>–§–ò–û</span>
                    <button class="icon-btn" id="btnScanPlate" title="–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è" style="width: 32px; height: 32px;">
                        <i class="fa-solid fa-camera"></i>
                    </button>
                </div>
                <input class="field-input" id="inName" type="text" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
                <div id="cameraContainer" style="display: none; margin-top: 10px; position: relative;">
                    <video id="video" autoplay playsinline style="width: 100%; height: 200px; object-fit: cover; border-radius: var(--radius); background: #000;"></video>
                    <canvas id="canvas" style="display: none;"></canvas>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn-done" id="captureBtn" style="flex: 1;">üì∏ –°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫</button>
                        <button class="btn-secondary" id="cancelCameraBtn" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                    <div id="ocrStatus" style="margin-top: 8px; font-size: 0.85rem; color: var(--text-secondary);"></div>
                </div>
            </div>
            <div class="field">
                <div class="field-label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
                <input class="field-input" id="inPhone" type="tel" placeholder="+7 (999) 123-45-67">
            </div>
            <div class="field">
                <div class="field-label">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</div>
                <input class="field-input" id="inCar" type="text" placeholder="Toyota Camry, –ê123–ë–í">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-done"><i class="fa-solid fa-check"></i> –ì–æ—Ç–æ–≤–æ</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="mWheels">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-head">
            <h2><i class="fa-solid fa-circle-dot"></i> –ö–æ–ª—ë—Å–∞</h2>
            <button class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <div class="field-label">–†–∞–¥–∏—É—Å</div>
            <div class="radius-grid" id="radiusGrid"></div>
            <div class="field-label">–¢–∏–ø</div>
            <div class="type-grid" id="typeGrid">
                <div class="type-btn" data-type="light"><i class="fa-solid fa-car"></i> –õ–µ–≥–∫–æ–≤–∞—è</div>
                <div class="type-btn" data-type="jeep"><i class="fa-solid fa-truck-monster"></i> –î–∂–∏–ø/–º–∏–Ω–∏–≤—ç–Ω/–∫—Ä–æ—Å—Å–æ–≤–µ—Ä</div>
                <div class="type-btn" data-type="lowProfile"><i class="fa-solid fa-bolt"></i> –ù–∏–∑–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å</div>
                <div class="type-btn" data-type="runflat"><i class="fa-solid fa-shield-halved"></i> RunFlat</div>
            </div>
            <div class="qty-row">
                <div class="qty-row-label"><i class="fa-solid fa-layer-group"></i> –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                <div class="qty-stepper">
                    <button id="wQtyMinus"><i class="fa-solid fa-minus"></i></button>
                    <span class="qty-val" id="wQtyVal">4</span>
                    <button id="wQtyPlus"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
            <div class="apply-all-bar" id="applyAll">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <span>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º –ø–æ–∑–∏—Ü–∏—è–º</span>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-done"><i class="fa-solid fa-check"></i> –ì–æ—Ç–æ–≤–æ</button>
        </div>
    </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –ú–ê–¢–ï–†–ò–ê–õ–û–í -->
<div class="modal-overlay" id="mMaterials">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-head">
            <h2><i class="fa-solid fa-box-open"></i> –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h2>
            <button class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <div class="items-list" id="matList"></div>
        </div>
        <div class="modal-footer">
            <div class="modal-footer-sum" id="matFooterSum"></div>
            <button class="btn-done"><i class="fa-solid fa-check"></i> –ì–æ—Ç–æ–≤–æ</button>
        </div>
    </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –£–°–õ–£–ì -->
<div class="modal-overlay" id="mServices">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-head">
            <h2><i class="fa-solid fa-wrench"></i> –£—Å–ª—É–≥–∏</h2>
            <button class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <div class="items-list" id="svcList"></div>
        </div>
        <div class="modal-footer">
            <div class="modal-footer-sum" id="svcFooterSum"></div>
            <button class="btn-done"><i class="fa-solid fa-check"></i> –ì–æ—Ç–æ–≤–æ</button>
        </div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="mSettings">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-head">
            <h2><i class="fa-solid fa-sliders"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ø–∏—Å–∫–æ–≤</h2>
            <button class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body" id="settingsBody"></div>
        <div class="modal-footer" style="flex-direction: column; gap: 8px;">
            <button class="btn-done" id="settingsSave"><i class="fa-solid fa-check"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- HISTORY MODAL -->
<div class="modal-overlay" id="mHistory">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-head">
            <h2><i class="fa-solid fa-clock-rotate-left"></i> –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h2>
            <button class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <div class="history-filters">
                <button class="filter-btn active" data-filter="today">–°–µ–≥–æ–¥–Ω—è</button>
                <button class="filter-btn" data-filter="week">–ù–µ–¥–µ–ª—è</button>
                <button class="filter-btn" data-filter="month">–ú–µ—Å—è—Ü</button>
                <button class="filter-btn" data-filter="all">–í—Å–µ</button>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-done" id="checkPaymentsBtn"><i class="fa-solid fa-rotate"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
            <button class="btn-secondary" id="clearHistoryBtn"><i class="fa-solid fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"><i class="fa-solid fa-circle-check"></i> <span id="toastMsg"></span></div>
<div class="confirm-overlay" id="confirmOverlay">
    <div class="confirm-dialog">
        <div class="confirm-body">
            <div class="confirm-title" id="confirmTitle"></div>
            <div class="confirm-text" id="confirmText"></div>
        </div>
        <div class="confirm-actions">
            <button class="confirm-cancel" id="confirmCancel">–û—Ç–º–µ–Ω–∞</button>
            <button class="confirm-ok" id="confirmOk">OK</button>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';

    const RADII = [13,14,15,16,17,18,19,20,21,22,23,24];

    // ------------------------------------------------------------------
    //  –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö —Å–ø–∏—Å–∫–æ–≤ (—ç—Ç–∞–ª–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
    // ------------------------------------------------------------------
    let MECHANICS = [];
    let MATERIALS = [];
    let SERVICES = [];

    // ------------------------------------------------------------------
    //  —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (—Ç–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞)
    // ------------------------------------------------------------------
    let state = {
        mechanics: [],
        client: { name: '', phone: '', car: '' },
        wheels: { radius: 17, types: { light: false, jeep: false, lowProfile: false, runflat: false }, qty: 4 },
        materials: [],
        services: []
    };

    // ------------------------------------------------------------------
    //  –∑–∞–≥—Ä—É–∑–∫–∞ / —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
    // ------------------------------------------------------------------
    const STORAGE_KEYS = {
        mechanics: 'tireShop_mechanics',
        materials: 'tireShop_materials',
        services: 'tireShop_services_v2',
        state: 'tireShop_state',
        orders: 'tireShop_orders',
        selectedSubdivision: 'tireShop_selectedSubdivision'
    };

    // ====== URL –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ Vercel ======
    const SETTINGS_PROXY_URL = 'https://1c-proxy-vercel.vercel.app/api/get-settings';
    const ORDER_PROXY_URL = 'https://1c-proxy-vercel.vercel.app/api/create-order';

    // ========== –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —É—Å–ª—É–≥ ==========
    function parseServices(services) {
        return services.map(svc => {
            const nameLower = svc.name.toLowerCase();
            
            // Parse radius if null
            if (svc.radius === null) {
                // –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —á–∏—Å–ª–æ –ø–æ—Å–ª–µ R (–Ω–∞–ø—Ä–∏–º–µ—Ä R14)
                const matchExact = nameLower.match(/r(\d+)/);
                if (matchExact) {
                    svc.radius = Number(matchExact[1]);
                } else {
                    // –ò—â–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω R12-13
                    const matchRange = nameLower.match(/r(\d+)-(\d+)/);
                    if (matchRange) {
                        svc.radius = `${matchRange[1]}-${matchRange[2]}`;
                    } else if (nameLower.includes('–∏ –±–æ–ª–µ–µ')) {
                        // –ò—â–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –ø–µ—Ä–µ–¥ "–∏ –±–æ–ª–µ–µ"
                        const matchMin = nameLower.match(/r(\d+)/);
                        if (matchMin) {
                            svc.radius = `${matchMin[1]} –∏ –±–æ–ª–µ–µ`;
                        }
                    }
                }
            }
            
            // Parse carType if null
            if (svc.carType === null) {
                if (nameLower.includes('–ª–µ–≥–∫–æ–≤–æ–≥–æ')) {
                    svc.carType = 'light';
                } else if (['–¥–∂–∏–ø', '–º–∏–Ω–∏–≤—ç–Ω', '–∫—Ä–æ—Å—Å–æ–≤–µ—Ä', '–ø–∞—Ä–∫–µ—Ç–Ω–∏–∫', '–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫'].some(word => nameLower.includes(word))) {
                    svc.carType = 'jeep';
                } else if (nameLower.includes('–≥–∞–∑–µ–ª—å')) {
                    svc.carType = 'jeep'; // –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–∏–ø, –Ω–æ –ø–æ —Ç–≤–æ–µ–º—É –∫–æ–¥—É –≥–∞–∑–µ–ª—å = jeep
                }
            }
            
            // Parse lowProfile / runflat if false
            if (!svc.lowProfile && nameLower.includes('–Ω–∏–∑–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å')) {
                svc.lowProfile = true;
            }
            if (!svc.runflat && nameLower.includes('runflat')) {
                svc.runflat = true;
            }
            
            return svc;
        });
    }

    // ========== –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ 1–° ==========
    async function loadSettingsFrom1C() {
        console.log('üîµ loadSettingsFrom1C –≤—ã–∑–≤–∞–Ω–∞');
        const subdivisionSelect = document.getElementById('subdivisionSelect');
        if (!subdivisionSelect) {
            console.error('üî¥ –≠–ª–µ–º–µ–Ω—Ç subdivisionSelect –Ω–µ –Ω–∞–π–¥–µ–Ω!');
            showToast('‚ùå –û—à–∏–±–∫–∞: —ç–ª–µ–º–µ–Ω—Ç –≤—ã–±–æ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        const subdivision = subdivisionSelect.value;
        console.log('üîµ –í—ã–±—Ä–∞–Ω–Ω–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:', subdivision);
        showToast('–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...');
        try {
            console.log('üü° –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫:', SETTINGS_PROXY_URL);
            const response = await fetch(SETTINGS_PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ subdivision: subdivision })
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            console.log('üü¢ –î–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
            if (data.success) {
                console.log('üü¢ –ú–µ—Ö–∞–Ω–∏–∫–∏:', data.mechanics);
                console.log('üü¢ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã:', data.materials);
                console.log('üü¢ –£—Å–ª—É–≥–∏:', data.services);
                
                MECHANICS = data.mechanics || [];
                MATERIALS = data.materials || [];
                SERVICES = data.services || [];
                
                // –ü–∞—Ä—Å–∏–º —É—Å–ª—É–≥–∏ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏–π
                SERVICES = parseServices(SERVICES);
                
                saveListsToStorage();
                localStorage.setItem(STORAGE_KEYS.selectedSubdivision, subdivision);
                reconcileStateWithLists();      // –æ–±–Ω–æ–≤–ª—è–µ–º state, –¥–æ–±–∞–≤–ª—è—è –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ —Å qty=0
                resetInvalidServices();         // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ, —á—Ç–æ –Ω–µ –ø–æ–¥—Ö–æ–¥—è—Ç –ø–æ–¥ —Ç–µ–∫—É—â–∏–µ –∫–æ–ª—ë—Å–∞
                updateAllDisplays();
                buildSettingsModal();
                showToast('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            } else {
                console.error('üî¥ –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö:', data.error);
                showToast('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (error) {
            console.error('üî¥ –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
            showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        }
    }

    function loadListsFromStorage() {
        const storedMech = localStorage.getItem(STORAGE_KEYS.mechanics);
        if (storedMech) { try { MECHANICS = JSON.parse(storedMech); } catch(e){ MECHANICS = []; } }
        if (!MECHANICS || !MECHANICS.length) {
            MECHANICS = ['–ê–Ω–¥—Ä–µ–µ–≤ –ê–Ω–¥—Ä–µ–π','–ë–æ—Ä–∏—Å–æ–≤ –ë–æ—Ä–∏—Å','–í–ª–∞—Å–æ–≤ –í–ª–∞–¥–∏—Å–ª–∞–≤','–ì—Ä–∏–≥–æ—Ä—å–µ–≤ –ì—Ä–∏–≥–æ—Ä–∏–π','–î–º–∏—Ç—Ä–∏–µ–≤ –î–º–∏—Ç—Ä–∏–π','–ï–≥–æ—Ä–æ–≤ –ï–≥–æ—Ä','–ñ—É–∫–æ–≤ –ñ–æ—Ä–∂','–ó–∞–π—Ü–µ–≤ –ó–∞—Ö–∞—Ä'];
        }

        const storedMat = localStorage.getItem(STORAGE_KEYS.materials);
        if (storedMat) { try { MATERIALS = JSON.parse(storedMat); } catch(e){ MATERIALS = []; } }
        if (!MATERIALS || !MATERIALS.length) {
            MATERIALS = [
                {id:1, name:'–†–∞—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã', price:150},{id:2, name:'–ì—Ä—É–∑–∏–∫ –Ω–∞–±–∏–≤–Ω–æ–π', price:50},{id:3, name:'–ì—Ä—É–∑–∏–∫ —Å–∞–º–æ–∫–ª–µ—é—â–∏–π—Å—è', price:80},
                {id:4, name:'–í–µ–Ω—Ç–∏–ª—å –ø—Ä–æ—Å—Ç–æ–π', price:100},{id:5, name:'–í–µ–Ω—Ç–∏–ª—å —Ö—Ä–æ–º', price:250},{id:6, name:'–ñ–≥—É—Ç', price:200}
            ];
        }

        const storedSvc = localStorage.getItem(STORAGE_KEYS.services);
        if (storedSvc) {
            try { SERVICES = JSON.parse(storedSvc); } catch(e){ SERVICES = []; }
            // –ü–∞—Ä—Å–∏–º —É—Å–ª—É–≥–∏
            SERVICES = parseServices(SERVICES);
        }
        if (!SERVICES || !SERVICES.length) {
            SERVICES = [
                {id:1, name:'–°—ä—ë–º –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–ª–µ—Å–∞ R16 light', price:300, radius:16, carType:'light', lowProfile:false, runflat:false},
                {id:2, name:'–î–µ–º–æ–Ω—Ç–∞–∂ —à–∏–Ω—ã R17 light', price:250, radius:17, carType:'light', lowProfile:false, runflat:false},
                {id:3, name:'–ú–æ–Ω—Ç–∞–∂ —à–∏–Ω—ã R17 light', price:250, radius:17, carType:'light', lowProfile:false, runflat:false},
                {id:4, name:'–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ R17 light', price:350, radius:17, carType:'light', lowProfile:false, runflat:false},
                {id:5, name:'–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –º–æ–π–∫–∞', price:200, radius:null, carType:null, lowProfile:false, runflat:false},
                {id:6, name:'–°–ª–æ–∂–Ω–æ—Å—Ç—å —Å –¥–∞—Ç—á–∏–∫–æ–º', price:500, radius:null, carType:null, lowProfile:false, runflat:false},
                {id:7, name:'–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—É–ø–∏—Ü—ã', price:150, radius:null, carType:null, lowProfile:false, runflat:false},
                {id:8, name:'–®–∏–Ω–æ—Ä–µ–º–æ–Ω—Ç –∂–≥—É—Ç–æ–º', price:400, radius:null, carType:null, lowProfile:false, runflat:false},
                {id:9, name:'–°—ä—ë–º –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã', price:350, radius:null, carType:null, lowProfile:false, runflat:false},
                {id:10, name:'–ü–æ–≥—Ä—É–∑–∫–∞ –∫–æ–ª–µ—Å–∞ –≤ —Å–±–æ—Ä–µ', price:100, radius:null, carType:null, lowProfile:false, runflat:false}
            ];
            SERVICES = parseServices(SERVICES);
        }
    }

    function saveListsToStorage() {
        localStorage.setItem(STORAGE_KEYS.mechanics, JSON.stringify(MECHANICS));
        localStorage.setItem(STORAGE_KEYS.materials, JSON.stringify(MATERIALS));
        localStorage.setItem(STORAGE_KEYS.services, JSON.stringify(SERVICES));
    }

    function loadStateFromStorage() {
        const stored = localStorage.getItem(STORAGE_KEYS.state);
        if (stored) {
            try { Object.assign(state, JSON.parse(stored)); } catch(e){}
        }
    }

    function saveStateToStorage() {
        localStorage.setItem(STORAGE_KEYS.state, JSON.stringify(state));
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è state —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ —Å–ø–∏—Å–∫–∞–º–∏ (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞, –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–æ–±–∞–≤–ª—è–µ–º —Å qty=0)
    function reconcileStateWithLists() {
        state.mechanics = state.mechanics.filter(name => MECHANICS.includes(name));

        const materialMap = new Map(state.materials.map(m => [m.id, m]));
        state.materials = MATERIALS.map(src => ({
            ...src,
            qty: materialMap.has(src.id) ? materialMap.get(src.id).qty : 0
        }));

        const serviceMap = new Map(state.services.map(s => [s.id, s]));
        state.services = SERVICES.map(src => ({
            ...src,
            qty: serviceMap.has(src.id) ? serviceMap.get(src.id).qty : 0
        }));
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–¥–Ω–∞ —É—Å–ª—É–≥–∞ —Ç–µ–∫—É—â–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∫–æ–ª—ë—Å (–¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥)
    function serviceMatchesWheels(svc, wheels) {
        const isConstant = svc.radius === null && svc.carType === null && svc.lowProfile === false && svc.runflat === false;
        if (isConstant) return true;

        // Radius check
        if (svc.radius !== null && wheels.radius) {
            const svcRadius = String(svc.radius);
            const wheelRadius = Number(wheels.radius);

            if (svcRadius.includes('-')) {
                const parts = svcRadius.split('-').map(Number);
                if (parts.length === 2) {
                    const [minRadius, maxRadius] = parts;
                    if (wheelRadius < minRadius || wheelRadius > maxRadius) {
                        return false;
                    }
                }
            } else if (svcRadius.includes('–±–æ–ª–µ–µ') || String(svc.name).includes('–∏ –±–æ–ª–µ–µ')) {
                const match = String(svc.name).match(/R(\d+)/);
                if (match) {
                    const minRadius = Number(match[1]);
                    if (wheelRadius < minRadius) {
                        return false;
                    }
                } else {
                    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –±–∞–≥: –µ—Å–ª–∏ wheel < svc.radius, —Ç–æ false
                    if (wheelRadius < Number(svc.radius)) {
                        return false;
                    }
                }
            } else if (Number(svcRadius) !== wheelRadius) {
                return false;
            }
        }

        // Car type check
        const svcName = String(svc.name).toLowerCase();
        const isLightService = svcName.includes('–ª–µ–≥–∫–æ–≤–æ–≥–æ') || svc.carType === 'light';
        const isJeepService = svcName.includes('–¥–∂–∏–ø') || svcName.includes('–º–∏–Ω–∏–≤—ç–Ω') ||
                              svcName.includes('–∫—Ä–æ—Å—Å–æ–≤–µ—Ä') || svcName.includes('–ø–∞—Ä–∫–µ—Ç–Ω–∏–∫') ||
                              svcName.includes('–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫') || svc.carType === 'jeep';
        const isGazelleService = svcName.includes('–≥–∞–∑–µ–ª—å');

        const isLightSelected = wheels.types.light;
        const isJeepSelected = wheels.types.jeep;

        if (isLightSelected && isJeepService && !isLightService) return false;
        if (isJeepSelected && isLightService && !isJeepService) return false;
        if (!isLightSelected && !isJeepSelected && (isLightService || isJeepService || isGazelleService)) {
            return false;
        }
        if (isGazelleService && !isJeepSelected) {
            return false;
        }

        // Low profile and runflat
        if (wheels.types.lowProfile) {
            const svcName = String(svc.name).toLowerCase();
            if (!svc.lowProfile && !svcName.includes('–Ω–∏–∑–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å')) return false;
        }
        if (wheels.types.runflat) {
            const svcName = String(svc.name).toLowerCase();
            if (!svc.runflat && !svcName.includes('runflat')) return false;
        }

        return true;
    }

    // –§–∏–ª—å—Ç—Ä –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ + –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –ø—Ä–æ—à–µ–¥—à–∏–µ —Ñ–∏–ª—å—Ç—Ä
    function filterServicesByWheels(services, wheels) {
        return services.filter(svc => {
            const isConstant = svc.radius === null && svc.carType === null && svc.lowProfile === false && svc.runflat === false;
            if (isConstant) return true;
            
            // –î–ª—è –Ω–µ–ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö —É—Å–ª—É–≥ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
            return serviceMatchesWheels(svc, wheels);
        });
    }

    // –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥, –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç–µ–∫—É—â–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
    function resetInvalidServices() {
        let changed = false;
        state.services = state.services.map(svc => {
            const isConstant = svc.radius === null && svc.carType === null && svc.lowProfile === false && svc.runflat === false;
            if (!isConstant && svc.qty > 0 && !serviceMatchesWheels(svc, state.wheels)) {
                svc.qty = 0;
                changed = true;
            }
            return svc;
        });
        if (changed) {
            updateAllDisplays();
            // –ï—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ª—É–≥ –æ—Ç–∫—Ä—ã—Ç–æ, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
            if (document.getElementById('mServices').classList.contains('active')) {
                const filtered = filterServicesByWheels(state.services, state.wheels);
                buildItemsModal('svcList', filtered);
                updateModalFooterSum('svcFooterSum', filtered);
            }
        }
    }

    function fmtPrice(n) { return n.toLocaleString('ru-RU') + ' ‚ÇΩ'; }
    
    function calcTotal() {
        let sum = 0;
        sum += state.materials.reduce((s, i) => s + (i.qty > 0 ? i.price * i.qty : 0), 0);
        state.services.forEach(svc => {
            if (svc.qty > 0) {
                sum += svc.price * svc.qty;
            }
        });
        return sum;
    }
    
    function calcItemsSum(items) { return items.reduce((s,i)=>s + (i.qty>0?i.price*i.qty:0),0); }
    
    function updateSaveBtn() {
        const sum = calcTotal();
        document.getElementById('btnSaveSum').textContent = sum > 0 ? fmtPrice(sum) : '';
    }

    function updateMechanicsDisp() {
        const el = document.getElementById('dMechanics');
        if (!state.mechanics.length) { el.className = 'card-subtitle'; el.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ö–∞–Ω–∏–∫–æ–≤'; }
        else {
            el.className = 'card-subtitle has-tags';
            el.innerHTML = state.mechanics.map(n => `<span class="mini-tag"><i class="fa-solid fa-user-gear"></i> ${n}</span>`).join('');
        }
    }
    function updateClientDisp() {
        const el = document.getElementById('dClient');
        const c = state.client;
        el.className = 'card-subtitle';
        if (!c.name && !c.phone && !c.car) el.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é';
        else el.textContent = [c.name, c.phone, c.car].filter(Boolean).join(' ¬∑ ');
    }
    function updateWheelsDisp() {
        const el = document.getElementById('dWheels');
        const w = state.wheels;
        el.className = 'card-subtitle has-tags';
        let tags = [`<span class="mini-tag" style="font-weight:700">R${w.radius}</span>`];
        const typeLabels = {light:'–õ–µ–≥–∫–æ–≤–∞—è',jeep:'–î–∂–∏–ø/–º–∏–Ω–∏–≤—ç–Ω/–∫—Ä–æ—Å—Å–æ–≤–µ—Ä',lowProfile:'–ù–∏–∑–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å',runflat:'RunFlat'};
        for (let k in w.types) if (w.types[k]) tags.push(`<span class="mini-tag">${typeLabels[k]}</span>`);
        tags.push(`<span class="mini-tag"><span class="cnt">${w.qty}</span> —à—Ç</span>`);
        el.innerHTML = tags.join('');
    }
    
    function formatServiceName(service) {
        return service.name; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    }
    
    function updateItemsDisp(elId, items, emptyText) {
        const el = document.getElementById(elId);
        const active = items.filter(i=>i.qty>0);
        if (!active.length) { 
            el.className = 'card-subtitle'; 
            el.textContent = emptyText; 
        }
        else {
            el.className = 'card-subtitle has-tags';
            el.innerHTML = active.map(i => {
                let displayName = i.name;
                // –î–ª—è —É—Å–ª—É–≥ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                if (elId === 'dServices') {
                    displayName = formatServiceName(i);
                }
                const shortName = displayName.length > 20 ? displayName.substring(0, 18) + '‚Ä¶' : displayName;
                return `<span class="mini-tag">${shortName}<span class="cnt">${i.qty}</span></span>`;
            }).join('');
        }
    }
    function updateAllDisplays() {
        updateMechanicsDisp();
        updateClientDisp();
        updateWheelsDisp();
        updateItemsDisp('dMaterials', state.materials, '–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π');
        updateItemsDisp('dServices', state.services, '–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π');
        updateSaveBtn();
    }

    function buildMechanicsModal() {
        const el = document.getElementById('mechList');
        el.innerHTML = MECHANICS.map(name => {
            const sel = state.mechanics.includes(name);
            return `<div class="mech-item${sel?' selected':''}" data-name="${name}"><div class="mech-check"><i class="fa-solid fa-check"></i></div><span class="mech-name">${name}</span></div>`;
        }).join('');
    }
    function fillClientModal() {
        document.getElementById('inName').value = state.client.name;
        document.getElementById('inPhone').value = state.client.phone;
        document.getElementById('inCar').value = state.client.car;
    }
    function buildWheelsModal() {
        const grid = document.getElementById('radiusGrid');
        grid.innerHTML = RADII.map(r => `<div class="radius-btn${r===state.wheels.radius?' active':''}" data-r="${r}">R${r}</div>`).join('');
        document.querySelectorAll('#typeGrid .type-btn').forEach(btn => {
            btn.classList.toggle('active', state.wheels.types[btn.dataset.type]);
        });
        document.getElementById('wQtyVal').textContent = state.wheels.qty;
    }
    
    function buildItemsModal(listId, items) {
        const el = document.getElementById(listId);
        el.innerHTML = items.map(item => {
            let priceLabel = fmtPrice(item.price);
            const id = item.id || item.name;
            let displayName = item.name;
            
            // –î–ª—è —É—Å–ª—É–≥ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –±–∞–∑—ã
            if (listId === 'svcList') {
                displayName = formatServiceName(item);
            }
            
            return `
                <div class="item-row${item.qty === 0 ? ' zero' : ''}" data-id="${id}">
                    <div class="item-name-block">
                        <div class="item-name">${displayName}</div>
                        <div class="item-price-label">${priceLabel} / —à—Ç</div>
                    </div>
                    <div class="item-controls">
                        <div class="item-select-wrap">
                            <select class="item-select" data-id="${id}">
                                ${Array.from({length:21}, (_,i) => `<option value="${i}" ${i === item.qty ? 'selected' : ''}>${i}</option>`).join('')}
                            </select>
                            <span class="item-select-arrow"><i class="fa-solid fa-chevron-down"></i></span>
                        </div>
                        <button class="item-delete" data-id="${id}"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function updateModalFooterSum(footerId, items) {
        const el = document.getElementById(footerId);
        if (!el) return;
        let sum = items.reduce((s, i) => s + (i.qty > 0 ? i.price * i.qty : 0), 0);
        el.innerHTML = sum > 0 ? `<span class="modal-footer-sum-label">–°—É–º–º–∞:</span><span class="modal-footer-sum-value">${fmtPrice(sum)}</span>` : '';
    }

    function buildSettingsModal() {
        const body = document.getElementById('settingsBody');
        let html = '';

        const savedSubdivision = localStorage.getItem(STORAGE_KEYS.selectedSubdivision) || '–û—Ä–µ–Ω–±—É—Ä–≥';
        html += `<div style="margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 16px;">
            <div class="field-label">–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ 1–°</div>
            <div style="display: flex; gap: 8px;">
                <select id="subdivisionSelect" style="flex: 1; background: var(--surface-2); border: none; border-radius: var(--radius-sm); padding: 10px; color: var(--text);;">
                    <option value="–û—Ä–µ–Ω–±—É—Ä–≥" ${savedSubdivision === '–û—Ä–µ–Ω–±—É—Ä–≥' ? 'selected' : ''}>–û—Ä–µ–Ω–±—É—Ä–≥</option>
                    <option value="–ù–æ–≤–æ–∫—É–π–±—ã—à–µ–≤—Å–∫" ${savedSubdivision === '–ù–æ–≤–æ–∫—É–π–±—ã—à–µ–≤—Å–∫' ? 'selected' : ''}>–ù–æ–≤–æ–∫—É–π–±—ã—à–µ–≤—Å–∫</option>
                    <option value="–ü–æ—Ö–≤–∏—Å—Ç–Ω–µ–≤–æ" ${savedSubdivision === '–ü–æ—Ö–≤–∏—Å—Ç–Ω–µ–≤–æ' ? 'selected' : ''}>–ü–æ—Ö–≤–∏—Å—Ç–Ω–µ–≤–æ</option>
                    <option value="–û—Ç—Ä–∞–¥–Ω—ã–π" ${savedSubdivision === '–û—Ç—Ä–∞–¥–Ω—ã–π' ? 'selected' : ''}>–û—Ç—Ä–∞–¥–Ω—ã–π</option>
                    <option value="–°–µ—Ä–¥–æ–±—Å–∫" ${savedSubdivision === '–°–µ—Ä–¥–æ–±—Å–∫' ? 'selected' : ''}>–°–µ—Ä–¥–æ–±—Å–∫</option>
                    <option value="–ë—É–∑—É–ª—É–∫" ${savedSubdivision === '–ë—É–∑—É–ª—É–∫' ? 'selected' : ''}>–ë—É–∑—É–ª—É–∫</option>
                    <option value="–°–æ—Ä–æ—á–∏–Ω—Å–∫" ${savedSubdivision === '–°–æ—Ä–æ—á–∏–Ω—Å–∫' ? 'selected' : ''}>–°–æ—Ä–æ—á–∏–Ω—Å–∫</option>
                </select>
                <button class="settings-add-btn" id="loadFrom1C" style="width: auto; padding: 10px 16px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </div>`;

        html += `<div class="settings-section"><div class="settings-section-title"><i class="fa-solid fa-users"></i> –ú–µ—Ö–∞–Ω–∏–∫–∏</div>`;
        MECHANICS.forEach((name) => {
            html += `<div class="settings-item" data-type="mech"><input type="text" class="mech-input" value="${name.replace(/"/g, '&quot;')}" placeholder="–§–ò–û"><button class="settings-delete" data-type="mech"><i class="fa-solid fa-trash-can"></i></button></div>`;
        });
        html += `<button class="settings-add-btn" id="addMech"><i class="fa-solid fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∫–∞</button></div>`;

        html += `<div class="settings-section"><div class="settings-section-title"><i class="fa-solid fa-box-open"></i> –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</div>`;
        MATERIALS.forEach((mat) => {
            html += `<div class="settings-item" data-type="mat" data-id="${mat.id}">
                <input type="text" class="mat-name" value="${mat.name.replace(/"/g, '&quot;')}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                <input type="number" class="price-input mat-price" value="${mat.price}" min="0" step="1" placeholder="–¶–µ–Ω–∞">
                <button class="settings-delete" data-type="mat"><i class="fa-solid fa-trash-can"></i></button>
            </div>`;
        });
        html += `<button class="settings-add-btn" id="addMat"><i class="fa-solid fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button></div>`;

        html += `<div class="settings-section"><div class="settings-section-title"><i class="fa-solid fa-wrench"></i> –£—Å–ª—É–≥–∏</div>`;
        SERVICES.forEach((svc) => {
            html += `<div class="settings-item" data-type="svc" data-id="${svc.id}">
                <input type="text" class="svc-name" value="${svc.name.replace(/"/g, '&quot;')}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" readonly style="background: var(--surface-3);">
                <input type="number" class="price-input svc-price" value="${svc.price}" min="0" step="1" placeholder="–¶–µ–Ω–∞" disabled style="opacity:0.5;">
                <span style="color: var(--text-muted); font-size:0.8rem;">–†–∞–¥–∏—É—Å: ${svc.radius ?? '–ª—é–±–æ–π'}</span>
                <span style="color: var(--text-muted); font-size:0.8rem;">–¢–∏–ø: ${svc.carType ?? '–ª—é–±–æ–π'}</span>
                <span style="color: var(--text-muted); font-size:0.8rem;">LowProfile: ${svc.lowProfile ? '–¥–∞' : '–Ω–µ—Ç'}</span>
                <span style="color: var(--text-muted); font-size:0.8rem;">Runflat: ${svc.runflat ? '–¥–∞' : '–Ω–µ—Ç'}</span>
                <button class="settings-delete" data-type="svc"><i class="fa-solid fa-trash-can"></i></button>
            </div>`;
        });
        html += `<button class="settings-add-btn" id="addSvc"><i class="fa-solid fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</button></div>`;

        html += `<button class="settings-reset-defaults" id="resetDefaults"><i class="fa-solid fa-rotate-left"></i> –°–±—Ä–æ—Å–∏—Ç—å –∫ –∑–∞–≤–æ–¥—Å–∫–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º</button>`;
        body.innerHTML = html;

        body.querySelectorAll('.settings-delete').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                btn.closest('.settings-item')?.remove();
            });
        });

        document.getElementById('addMech')?.addEventListener('click', () => {
            const section = document.querySelector('[data-type="mech"]')?.closest('.settings-section') || body.querySelector('.settings-section');
            const newItem = document.createElement('div');
            newItem.className = 'settings-item';
            newItem.dataset.type = 'mech';
            newItem.innerHTML = `<input type="text" class="mech-input" value="–ù–æ–≤—ã–π –º–µ—Ö–∞–Ω–∏–∫" placeholder="–§–ò–û"><button class="settings-delete" data-type="mech"><i class="fa-solid fa-trash-can"></i></button>`;
            section.insertBefore(newItem, document.getElementById('addMech'));
            newItem.querySelector('.settings-delete').addEventListener('click', (e) => { e.stopPropagation(); newItem.remove(); });
        });

        document.getElementById('addMat')?.addEventListener('click', () => {
            const section = document.querySelector('[data-type="mat"]')?.closest('.settings-section') || body.querySelectorAll('.settings-section')[1];
            const newId = Date.now() + Math.floor(Math.random()*1000);
            const newItem = document.createElement('div');
            newItem.className = 'settings-item';
            newItem.dataset.type = 'mat';
            newItem.dataset.id = newId;
            newItem.innerHTML = `<input type="text" class="mat-name" value="–ù–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><input type="number" class="price-input mat-price" value="100" min="0" step="1" placeholder="–¶–µ–Ω–∞"><button class="settings-delete" data-type="mat"><i class="fa-solid fa-trash-can"></i></button>`;
            section.insertBefore(newItem, document.getElementById('addMat'));
            newItem.querySelector('.settings-delete').addEventListener('click', (e) => { e.stopPropagation(); newItem.remove(); });
        });

        document.getElementById('addSvc')?.addEventListener('click', () => {
            const section = document.querySelector('[data-type="svc"]')?.closest('.settings-section') || body.querySelectorAll('.settings-section')[2];
            const newId = Date.now() + Math.floor(Math.random()*1000) + 1000;
            const newItem = document.createElement('div');
            newItem.className = 'settings-item';
            newItem.dataset.type = 'svc';
            newItem.dataset.id = newId;
            newItem.innerHTML = `
                <input type="text" class="svc-name" value="–ù–æ–≤–∞—è —É—Å–ª—É–≥–∞" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                <input type="number" class="price-input svc-price" value="200" min="0" step="1" placeholder="–¶–µ–Ω–∞">
                <input type="text" class="svc-radius" placeholder="–†–∞–¥–∏—É—Å (–∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω)">
                <select class="svc-car-type"><option value="">–õ—é–±–æ–π</option><option value="light">–õ–µ–≥–∫–æ–≤–∞—è</option><option value="jeep">–î–∂–∏–ø</option></select>
                <label><input type="checkbox" class="svc-low-profile"> –Ω–∏–∑–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å</label>
                <label><input type="checkbox" class="svc-runflat"> runflat</label>
                <button class="settings-delete" data-type="svc"><i class="fa-solid fa-trash-can"></i></button>`;
            section.insertBefore(newItem, document.getElementById('addSvc'));
            newItem.querySelector('.settings-delete').addEventListener('click', (e) => { e.stopPropagation(); newItem.remove(); });
        });

        document.getElementById('resetDefaults')?.addEventListener('click', () => {
            MECHANICS = ['–ê–Ω–¥—Ä–µ–µ–≤ –ê–Ω–¥—Ä–µ–π','–ë–æ—Ä–∏—Å–æ–≤ –ë–æ—Ä–∏—Å','–í–ª–∞—Å–æ–≤ –í–ª–∞–¥–∏—Å–ª–∞–≤','–ì—Ä–∏–≥–æ—Ä—å–µ–≤ –ì—Ä–∏–≥–æ—Ä–∏–π','–î–º–∏—Ç—Ä–∏–µ–≤ –î–º–∏—Ç—Ä–∏–π','–ï–≥–æ—Ä–æ–≤ –ï–≥–æ—Ä','–ñ—É–∫–æ–≤ –ñ–æ—Ä–∂','–ó–∞–π—Ü–µ–≤ –ó–∞—Ö–∞—Ä'];
            MATERIALS = [
                {id:1, name:'–†–∞—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã', price:150},{id:2, name:'–ì—Ä—É–∑–∏–∫ –Ω–∞–±–∏–≤–Ω–æ–π', price:50},{id:3, name:'–ì—Ä—É–∑–∏–∫ —Å–∞–º–æ–∫–ª–µ—é—â–∏–π—Å—è', price:80},
                {id:4, name:'–í–µ–Ω—Ç–∏–ª—å –ø—Ä–æ—Å—Ç–æ–π', price:100},{id:5, name:'–í–µ–Ω—Ç–∏–ª—å —Ö—Ä–æ–º', price:250},{id:6, name:'–ñ–≥—É—Ç', price:200}
            ];
            SERVICES = [
                {id:1, name:'–°—ä—ë–º –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–ª–µ—Å–∞ R16 light', price:300, radius:16, carType:'light', lowProfile:false, runflat:false},
                {id:2, name:'–î–µ–º–æ–Ω—Ç–∞–∂ —à–∏–Ω—ã R17 light', price:250, radius:17, carType:'light', lowProfile:false, runflat:false},
                {id:3, name:'–ú–æ–Ω—Ç–∞–∂ —à–∏–Ω—ã R17 light', price:250, radius:17, carType:'light', lowProfile:false, runflat:false},
                {id:4, name:'–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ R17 light', price:350, radius:17, carType:'light', lowProfile:false, runflat:false},
                {id:5, name:'–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –º–æ–π–∫–∞', price:200, radius:null, carType:null, lowProfile:false, runflat:false},
                {id:6, name:'–°–ª–æ–∂–Ω–æ—Å—Ç—å —Å –¥–∞—Ç—á–∏–∫–æ–º', price:500, radius:null, carType:null, lowProfile:false, runflat:false},
                {id:7, name:'–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—É–ø–∏—Ü—ã', price:150, radius:null, carType:null, lowProfile:false, runflat:false},
                {id:8, name:'–®–∏–Ω–æ—Ä–µ–º–æ–Ω—Ç –∂–≥—É—Ç–æ–º', price:400, radius:null, carType:null, lowProfile:false, runflat:false},
                {id:9, name:'–°—ä—ë–º –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã', price:350, radius:null, carType:null, lowProfile:false, runflat:false},
                {id:10, name:'–ü–æ–≥—Ä—É–∑–∫–∞ –∫–æ–ª–µ—Å–∞ –≤ —Å–±–æ—Ä–µ', price:100, radius:null, carType:null, lowProfile:false, runflat:false}
            ];
            SERVICES = parseServices(SERVICES);
            buildSettingsModal();
        });

        document.getElementById('loadFrom1C')?.addEventListener('click', loadSettingsFrom1C);
    }

    function saveSettings() {
        const newMech = [];
        document.querySelectorAll('#settingsBody .settings-item[data-type="mech"] .mech-input').forEach(inp => {
            const val = inp.value.trim();
            if (val) newMech.push(val);
        });
        MECHANICS = newMech;

        const newMats = [];
        document.querySelectorAll('#settingsBody .settings-item[data-type="mat"]').forEach(row => {
            const name = row.querySelector('.mat-name')?.value.trim();
            const price = parseInt(row.querySelector('.mat-price')?.value, 10);
            const id = row.dataset.id ? Number(row.dataset.id) : Date.now() + Math.random();
            if (name && !isNaN(price) && price >= 0) newMats.push({ id, name, price });
        });
        MATERIALS = newMats;

        const newSvcs = [];
        document.querySelectorAll('#settingsBody .settings-item[data-type="svc"]').forEach(row => {
            const name = row.querySelector('.svc-name')?.value.trim();
            const price = parseInt(row.querySelector('.svc-price')?.value, 10);
            const id = row.dataset.id ? Number(row.dataset.id) : Date.now() + Math.random() + 1000;
            if (!name || isNaN(price) || price < 0) return;

            const radiusInput = row.querySelector('.svc-radius')?.value;
            const radius = radiusInput ? (isNaN(radiusInput) ? radiusInput : Number(radiusInput)) : null;

            const carTypeSelect = row.querySelector('.svc-car-type')?.value;
            const carType = carTypeSelect || null;

            const lowProfile = row.querySelector('.svc-low-profile')?.checked || false;
            const runflat = row.querySelector('.svc-runflat')?.checked || false;

            newSvcs.push({ id, name, price, radius, carType, lowProfile, runflat });
        });
        SERVICES = newSvcs;
        SERVICES = parseServices(SERVICES);

        saveListsToStorage();
        reconcileStateWithLists();
        saveStateToStorage();
        updateAllDisplays();
    }

    function saveCurrentModal(overlay) {
        const id = overlay.id;
        if (id === 'mMechanics') {
            state.mechanics = [...document.querySelectorAll('#mechList .mech-item.selected')].map(el=>el.dataset.name);
            updateMechanicsDisp();
        } else if (id === 'mClient') {
            state.client.name = document.getElementById('inName').value.trim();
            state.client.phone = document.getElementById('inPhone').value.trim();
            state.client.car = document.getElementById('inCar').value.trim();
            updateClientDisp();
        } else if (id === 'mWheels') {
            const activeR = document.querySelector('#radiusGrid .radius-btn.active');
            if (activeR) state.wheels.radius = parseInt(activeR.dataset.r);
            document.querySelectorAll('#typeGrid .type-btn').forEach(btn => {
                state.wheels.types[btn.dataset.type] = btn.classList.contains('active');
            });
            state.wheels.qty = parseInt(document.getElementById('wQtyVal').textContent);
            updateWheelsDisp();
            
            // –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–ª—ë—Å —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª—É–≥–∏
            resetInvalidServices();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ª—É–≥ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
            updateItemsDisp('dServices', state.services, '–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π');
            
            // –ï—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ª—É–≥ –æ—Ç–∫—Ä—ã—Ç–æ, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            const servicesModal = document.getElementById('mServices');
            if (servicesModal && servicesModal.classList.contains('active')) {
                const filtered = filterServicesByWheels(state.services, state.wheels);
                buildItemsModal('svcList', filtered);
                updateModalFooterSum('svcFooterSum', filtered);
            }
        } else if (id === 'mMaterials') {
            document.querySelectorAll('#matList .item-row').forEach(row => {
                const id = row.dataset.id;
                const select = row.querySelector('.item-select');
                if (id && select) {
                    const qty = parseInt(select.value);
                    const material = state.materials.find(m => String(m.id) === id);
                    if (material) material.qty = qty;
                }
            });
            updateItemsDisp('dMaterials', state.materials, '–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π');
        } else if (id === 'mServices') {
            document.querySelectorAll('#svcList .item-row').forEach(row => {
                const id = row.dataset.id;
                const select = row.querySelector('.item-select');
                if (id && select) {
                    const qty = parseInt(select.value);
                    const service = state.services.find(s => String(s.id) === id);
                    if (service) service.qty = qty;
                }
            });
            updateItemsDisp('dServices', state.services, '–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π');
        }
        updateSaveBtn();
        saveStateToStorage();
    }

    const modalMap = {
        mechanics: 'mMechanics', client: 'mClient', wheels: 'mWheels',
        materials: 'mMaterials', services: 'mServices', settings: 'mSettings',
        history: 'mHistory'
    };

    function openModal(name) {
        const id = modalMap[name];
        if (!id) return;
        if (name === 'mechanics') buildMechanicsModal();
        if (name === 'client') fillClientModal();
        if (name === 'wheels') buildWheelsModal();
        if (name === 'materials') { buildItemsModal('matList', state.materials); updateModalFooterSum('matFooterSum', state.materials); }
        if (name === 'services') {
            const filtered = filterServicesByWheels(state.services, state.wheels);
            buildItemsModal('svcList', filtered);
            updateModalFooterSum('svcFooterSum', filtered);
        }
        if (name === 'settings') buildSettingsModal();
        if (name === 'history') renderHistoryList('today');

        document.getElementById(id).classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(overlay) {
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    // ========== –ò–°–¢–û–†–ò–Ø –ó–ê–ö–ê–ó–û–í ==========
    let orders = [];

    function loadOrdersFromStorage() {
        const stored = localStorage.getItem(STORAGE_KEYS.orders);
        if (stored) {
            try { orders = JSON.parse(stored); } catch(e){ orders = []; }
        }
    }
    function saveOrdersToStorage() {
        localStorage.setItem(STORAGE_KEYS.orders, JSON.stringify(orders));
    }
    function addOrder(orderData) {
        const newOrder = {
            id: Date.now().toString(),
            date: new Date().toISOString(),
            clientName: orderData.client.name,
            mechanics: orderData.manager.split(', '),
            orderNumber1C: orderData.orderNumber,
            amount: orderData.amount || 0,
            paid: false,
            lastCheckDate: null,
            services: orderData.services || '',
            materials: orderData.materials || ''
        };
        orders.unshift(newOrder);
        saveOrdersToStorage();
        return newOrder;
    }
    function updatePaymentStatus(orderNumbers) {
        orderNumbers.forEach(number => {
            const order = orders.find(o => o.orderNumber1C === number);
            if (order) { order.paid = true; order.lastCheckDate = new Date().toISOString(); }
        });
        saveOrdersToStorage();
        renderHistoryList(currentFilter);
    }
    let currentFilter = 'today';
    function filterOrders(filter) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        switch(filter) {
            case 'today': return orders.filter(o => new Date(o.date) >= today);
            case 'week':
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                return orders.filter(o => new Date(o.date) >= weekAgo);
            case 'month':
                const monthAgo = new Date(today);
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                return orders.filter(o => new Date(o.date) >= monthAgo);
            default: return orders;
        }
    }
    function renderHistoryList(filter = 'today') {
        currentFilter = filter;
        const listEl = document.getElementById('historyList');
        const filtered = filterOrders(filter);
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === filter);
        });
        if (filtered.length === 0) {
            listEl.innerHTML = '<div class="empty-state">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
            return;
        }
        listEl.innerHTML = filtered.map(order => `
            <div class="history-item">
                <div class="history-item-paid ${order.paid ? 'paid' : 'unpaid'}"><i class="fa-solid ${order.paid ? 'fa-check' : 'fa-xmark'}"></i></div>
                <div class="history-item-content">
                    <div class="history-item-header"><span class="history-item-number">${order.orderNumber1C}</span><span class="history-item-date">${new Date(order.date).toLocaleString()}</span></div>
                    <div class="history-item-client">${order.clientName}</div>
                    <div class="history-item-mechanics">${order.mechanics.join(', ')}</div>
                </div>
                <div class="history-item-amount">${order.amount.toLocaleString()} ‚ÇΩ</div>
            </div>
        `).join('');
    }
    async function checkPayments() {
        const unpaidOrders = orders.filter(o => !o.paid).map(o => o.orderNumber1C);
        if (unpaidOrders.length === 0) { showToast('–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏'); return; }
        showToast('–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã...');
        setTimeout(() => {
            const paidCount = Math.floor(Math.random() * 3) + 1;
            const paidOrders = unpaidOrders.slice(0, paidCount);
            updatePaymentStatus(paidOrders);
            showToast(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${paidCount} –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤`);
        }, 1500);
    }
    function clearHistory() {
        showConfirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?', '–ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤—Å–µ –∑–∞–∫–∞–∑—ã —Å—Ç–∞—Ä—à–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è.')
            .then(confirmed => { if (confirmed) showToast('–ó–∞–≥–ª—É—à–∫–∞: –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏'); });
    }

    // ========== –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –ù–û–ú–ï–†–ê ==========
    let scanStream = null;
    const loadTesseract = () => {
        return new Promise((resolve) => {
            if (window.Tesseract) { resolve(window.Tesseract); }
            else {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js';
                script.onload = () => resolve(window.Tesseract);
                document.head.appendChild(script);
            }
        });
    };
    function preprocessImage(canvas) {
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            let r = data[i]; let g = data[i+1]; let b = data[i+2];
            let gray = 0.2126 * r + 0.7152 * g + 0.0722 * b;
            let val = gray > 128 ? 0 : 255;
            data[i] = data[i+1] = data[i+2] = val;
        }
        ctx.putImageData(imageData, 0, 0);
    }
    function extractPlate(text) {
        const replaceMap = {
            '–ê':'A','–í':'B','–ï':'E','–ö':'K','–ú':'M','–ù':'H','–û':'O','–†':'P','–°':'C','–¢':'T','–£':'Y','–•':'X',
            '–∞':'a','–≤':'b','–µ':'e','–∫':'k','–º':'m','–Ω':'h','–æ':'o','—Ä':'p','—Å':'c','—Ç':'t','—É':'y','—Ö':'x'
        };
        let converted = '';
        for (let ch of text) { if (replaceMap[ch]) converted += replaceMap[ch]; else converted += ch; }
        const allowed = converted.replace(/[^A-Za-z0-9]/g, '');
        const match = allowed.match(/[A-Za-z0-9]{6,10}/);
        return match ? match[0] : '';
    }
    document.getElementById('btnScanPlate')?.addEventListener('click', async () => {
        const cameraContainer = document.getElementById('cameraContainer');
        const video = document.getElementById('video');
        try {
            scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = scanStream;
            cameraContainer.style.display = 'block';
            await loadTesseract();
        } catch (err) {
            showToast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ');
            console.error(err);
        }
    });
    document.getElementById('captureBtn')?.addEventListener('click', async () => {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const ocrStatus = document.getElementById('ocrStatus');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        preprocessImage(canvas);
        ocrStatus.textContent = '‚è≥ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ...';
        try {
            const Tesseract = await loadTesseract();
            const result = await Tesseract.recognize(canvas, 'eng', {
                logger: m => console.log(m),
                tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789',
                tessedit_pageseg_mode: 7
            });
            const rawText = result.data.text;
            const plate = extractPlate(rawText);
            ocrStatus.textContent = plate ? '‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ' : '‚ùå –ù–æ–º–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω';
            document.getElementById('inName').value = plate || '[–Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å]';
        } catch (error) {
            ocrStatus.textContent = '‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è';
            console.error(error);
        } finally {
            if (scanStream) { scanStream.getTracks().forEach(track => track.stop()); scanStream = null; }
            document.getElementById('cameraContainer').style.display = 'none';
            document.getElementById('video').srcObject = null;
        }
    });
    document.getElementById('cancelCameraBtn')?.addEventListener('click', () => {
        if (scanStream) { scanStream.getTracks().forEach(track => track.stop()); scanStream = null; }
        document.getElementById('cameraContainer').style.display = 'none';
        document.getElementById('video').srcObject = null;
        document.getElementById('ocrStatus').textContent = '';
    });

    // ========== –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ ==========
    async function createOrder() {
        if (state.mechanics.length === 0) {
            showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∫–∞');
            return;
        }
        if (!state.client.name || !state.client.phone || !state.client.car) {
            showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –∞–≤—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞');
            return;
        }
        if (!state.services.some(s => s.qty > 0)) {
            showToast('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É');
            return;
        }

        const confirmed = await showConfirm('–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑?', '–î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ 1–°.');
        if (!confirmed) return;

        const orderData = {
            manager: state.mechanics.join(', '),
            client: {
                name: state.client.name,
                phone: state.client.phone,
                car: state.client.car
            },
            wheels: {
                radius: state.wheels.radius,
                types: state.wheels.types,
                qty: state.wheels.qty
            },
            materials: state.materials.filter(m => m.qty > 0).map(m => ({
                id: m.id,
                name: m.name,
                price: m.price,
                qty: m.qty
            })),
            services: state.services.filter(s => s.qty > 0).map(s => ({
                id: s.id,
                name: s.name,
                price: s.price,
                qty: s.qty,
                radius: s.radius,
                carType: s.carType,
                lowProfile: s.lowProfile,
                runflat: s.runflat
            }))
        };

        const payload = {
            action: 'create_order_tyre',
            data: orderData
        };

        showToast('–û—Ç–ø—Ä–∞–≤–∫–∞...');
        try {
            const response = await fetch(ORDER_PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.success) {
                showToast(`‚úÖ –ó–∞–∫–∞–∑ ‚Ññ${result.orderNumber} —Å–æ–∑–¥–∞–Ω`);
                localStorage.setItem('lastOrderNumber', result.orderNumber);
                const servicesString = state.services.filter(s => s.qty > 0).map(s => {
                    return `${s.name} x${s.qty}`;
                }).join(', ');
                const materialsString = state.materials.filter(m => m.qty > 0).map(m => `${m.name} x${m.qty}`).join(', ');
                addOrder({
                    client: state.client,
                    manager: state.mechanics.join(', '),
                    orderNumber: result.orderNumber,
                    amount: calcTotal(),
                    services: servicesString,
                    materials: materialsString
                });
            } else {
                showToast(`‚ùå –û—à–∏–±–∫–∞: ${result.error || result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        }
    }

    function init() {
        loadListsFromStorage();
        loadStateFromStorage();
        loadOrdersFromStorage();
        reconcileStateWithLists();
        updateAllDisplays();

        document.getElementById('btnSettings').addEventListener('click', () => openModal('settings'));
        document.getElementById('btnHistory').addEventListener('click', () => openModal('history'));
        document.getElementById('btnCreateOrder').addEventListener('click', createOrder);

        document.querySelectorAll('.card[data-modal]').forEach(card => {
            card.addEventListener('click', () => openModal(card.dataset.modal));
        });

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', e => {
                if (e.target === overlay) {
                    if (overlay.id === 'mSettings' || overlay.id === 'mHistory') closeModal(overlay);
                    else { saveCurrentModal(overlay); closeModal(overlay); }
                }
            });
        });

        document.querySelectorAll('.modal-close-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const overlay = btn.closest('.modal-overlay');
                if (overlay.id === 'mSettings' || overlay.id === 'mHistory') closeModal(overlay);
                else { saveCurrentModal(overlay); closeModal(overlay); }
            });
        });

        document.querySelectorAll('.modal-footer .btn-done').forEach(btn => {
            btn.addEventListener('click', () => {
                const overlay = btn.closest('.modal-overlay');
                if (overlay.id === 'mSettings') {
                    saveSettings();
                    closeModal(overlay);
                    showToast('–°–ø–∏—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                } else if (overlay.id === 'mHistory') {
                    closeModal(overlay);
                } else {
                    saveCurrentModal(overlay);
                    closeModal(overlay);
                    showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                }
            });
        });

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => renderHistoryList(btn.dataset.filter));
        });

        document.getElementById('checkPaymentsBtn')?.addEventListener('click', checkPayments);
        document.getElementById('clearHistoryBtn')?.addEventListener('click', clearHistory);

        document.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.target.closest('button') && !e.target.closest('select') && !e.target.closest('.settings-item')) {
                const active = document.querySelector('.modal-overlay.active');
                if (active && active.id !== 'mSettings' && active.id !== 'mHistory') {
                    e.preventDefault();
                    saveCurrentModal(active);
                    closeModal(active);
                    showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                }
            }
        });

        document.getElementById('mechList')?.addEventListener('click', e => {
            const item = e.target.closest('.mech-item');
            if (item) item.classList.toggle('selected');
        });

        document.getElementById('inPhone')?.addEventListener('input', function() {
            let d = this.value.replace(/\D/g, '');
            if (d.startsWith('8') && d.length>1) d='7'+d.substring(1);
            if (!d.startsWith('7') && d.length>0) d='7'+d;
            let out = '';
            if (d.length>0) out='+'+d[0];
            if (d.length>1) out+=' ('+d.substring(1,Math.min(4,d.length));
            if (d.length>=4) out+=') ';
            if (d.length>4) out+=d.substring(4,Math.min(7,d.length));
            if (d.length>7) out+='-'+d.substring(7,Math.min(9,d.length));
            if (d.length>9) out+='-'+d.substring(9,Math.min(11,d.length));
            this.value = out;
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–¥–∏—É—Å–∞ - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ –µ—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
        document.getElementById('radiusGrid')?.addEventListener('click', e => {
            const btn = e.target.closest('.radius-btn');
            if (!btn) return;
            document.querySelectorAll('#radiusGrid .radius-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            
            // –ï—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ª—É–≥ –æ—Ç–∫—Ä—ã—Ç–æ, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ —Å—Ä–∞–∑—É
            const servicesModal = document.getElementById('mServices');
            if (servicesModal && servicesModal.classList.contains('active')) {
                // –í—Ä–µ–º–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º state.wheels.radius –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                const newRadius = parseInt(btn.dataset.r);
                const filtered = filterServicesByWheels(state.services, {
                    ...state.wheels,
                    radius: newRadius
                });
                buildItemsModal('svcList', filtered);
                updateModalFooterSum('svcFooterSum', filtered);
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–∏–ø–∞ - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ –µ—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
        document.getElementById('typeGrid')?.addEventListener('click', e => {
            const btn = e.target.closest('.type-btn');
            if (!btn) return;
            const type = btn.dataset.type;
            if (type==='light' || type==='jeep') {
                const other = document.querySelector(`#typeGrid .type-btn[data-type="${type==='light'?'jeep':'light'}"]`);
                if (btn.classList.contains('active')) btn.classList.remove('active');
                else { 
                    btn.classList.add('active'); 
                    other?.classList.remove('active'); 
                }
            } else btn.classList.toggle('active');
            
            // –ï—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ª—É–≥ –æ—Ç–∫—Ä—ã—Ç–æ, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ —Å—Ä–∞–∑—É
            const servicesModal = document.getElementById('mServices');
            if (servicesModal && servicesModal.classList.contains('active')) {
                // –í—Ä–µ–º–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º state.wheels.types –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                const newTypes = {...state.wheels.types};
                document.querySelectorAll('#typeGrid .type-btn').forEach(btn => {
                    newTypes[btn.dataset.type] = btn.classList.contains('active');
                });
                const filtered = filterServicesByWheels(state.services, {
                    ...state.wheels,
                    types: newTypes
                });
                buildItemsModal('svcList', filtered);
                updateModalFooterSum('svcFooterSum', filtered);
            }
        });

        document.getElementById('wQtyMinus')?.addEventListener('click', ()=>{
            const el = document.getElementById('wQtyVal');
            let v = parseInt(el.textContent);
            if (v>1) el.textContent = --v;
            updateSaveBtn();
        });
        document.getElementById('wQtyPlus')?.addEventListener('click', ()=>{
            const el = document.getElementById('wQtyVal');
            let v = parseInt(el.textContent);
            if (v<20) el.textContent = ++v;
            updateSaveBtn();
        });

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö applyAll
        document.getElementById('applyAll')?.addEventListener('click', async () => {
            const qty = parseInt(document.getElementById('wQtyVal').textContent);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ –≤—Å–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
            state.materials.forEach(m => m.qty = qty);
            
            // –î–ª—è —É—Å–ª—É–≥ –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ª—å–∫–æ –∫ —Ç–µ–º, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç–µ–∫—É—â–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∫–æ–ª—ë—Å
            const filteredServices = filterServicesByWheels(state.services, state.wheels);
            filteredServices.forEach(svc => {
                const service = state.services.find(s => s.id === svc.id);
                if (service) service.qty = qty;
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            buildItemsModal('matList', state.materials);
            buildItemsModal('svcList', filterServicesByWheels(state.services, state.wheels));
            updateItemsDisp('dMaterials', state.materials, '–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π');
            updateItemsDisp('dServices', state.services, '–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π');
            updateSaveBtn();
            showToast(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ${qty} –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ ${filteredServices.length} —É—Å–ª—É–≥–∞–º –∏ –≤—Å–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º`);
        });

        // –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è select –∏ delete
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('item-select')) {
                const row = e.target.closest('.item-row');
                if (!row) return;
                const id = row.dataset.id;
                const listId = row.closest('.items-list')?.id;
                if (!listId) return;
                const qty = parseInt(e.target.value);
                if (listId === 'matList') {
                    const material = state.materials.find(m => String(m.id) === id);
                    if (material) material.qty = qty;
                    updateModalFooterSum('matFooterSum', state.materials);
                } else if (listId === 'svcList') {
                    const service = state.services.find(s => String(s.id) === id);
                    if (service) service.qty = qty;
                    updateModalFooterSum('svcFooterSum', state.services);
                }
                updateSaveBtn();
            }
        });

        document.addEventListener('click', function(e) {
            if (e.target.closest('.item-delete')) {
                const btn = e.target.closest('.item-delete');
                const row = btn.closest('.item-row');
                if (!row) return;
                const id = row.dataset.id;
                const listId = row.closest('.items-list')?.id;
                if (!listId) return;
                if (listId === 'matList') {
                    const material = state.materials.find(m => String(m.id) === id);
                    if (material) material.qty = 0;
                    const select = row.querySelector('.item-select');
                    if (select) select.value = 0;
                    row.classList.add('zero');
                    updateModalFooterSum('matFooterSum', state.materials);
                } else if (listId === 'svcList') {
                    const service = state.services.find(s => String(s.id) === id);
                    if (service) service.qty = 0;
                    const select = row.querySelector('.item-select');
                    if (select) select.value = 0;
                    row.classList.add('zero');
                    updateModalFooterSum('svcFooterSum', state.services);
                }
                updateSaveBtn();
            }
        });

        document.getElementById('btnReset').addEventListener('click', async () => {
            if (await showConfirm('–°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É?', '–í—Å–µ –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
                state = {
                    mechanics: [],
                    client: {name:'',phone:'',car:''},
                    wheels: {radius:17, types:{light:false,jeep:false,lowProfile:false,runflat:false}, qty:4},
                    materials: MATERIALS.map(m=>({...m, qty:0})),
                    services: SERVICES.map(s=>({...s, qty:0}))
                };
                updateAllDisplays();
                saveStateToStorage();
                showToast('–§–æ—Ä–º–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
            }
        });

        let touchStartY = 0;
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('touchstart', e => { touchStartY = e.touches[0].clientY; }, {passive: true});
            modal.addEventListener('touchend', e => {
                const dy = e.changedTouches[0].clientY - touchStartY;
                const body = modal.querySelector('.modal-body');
                if (dy > 80 && (!body || body.scrollTop <= 0)) {
                    const overlay = modal.closest('.modal-overlay');
                    if (overlay.id === 'mSettings' || overlay.id === 'mHistory') closeModal(overlay);
                    else { saveCurrentModal(overlay); closeModal(overlay); }
                }
            }, {passive: true});
        });

        let toastTimer;
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            t.classList.add('show');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
        }
        window.showToast = showToast;

        async function showConfirm(title, text) {
            return new Promise(resolve => {
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmText').textContent = text;
                const overlay = document.getElementById('confirmOverlay');
                overlay.classList.add('active');
                const onOk = () => { cleanup(); resolve(true); };
                const onCancel = () => { cleanup(); resolve(false); };
                const onBg = (e) => { if (e.target === overlay) { cleanup(); resolve(false); } };
                function cleanup() {
                    overlay.classList.remove('active');
                    document.getElementById('confirmOk').removeEventListener('click', onOk);
                    document.getElementById('confirmCancel').removeEventListener('click', onCancel);
                    overlay.removeEventListener('click', onBg);
                }
                document.getElementById('confirmOk').addEventListener('click', onOk);
                document.getElementById('confirmCancel').addEventListener('click', onCancel);
                overlay.addEventListener('click', onBg);
            });
        }
        window.showConfirm = showConfirm;
    }

    init();
})();
</script>
</body>
</html>