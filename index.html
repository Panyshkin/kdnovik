<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>Шиномонтаж</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg: #000000;
            --surface: #1c1c1e;
            --surface-2: #2c2c2e;
            --surface-3: #3a3a3c;
            --border: #38383a;
            --border-hover: #48484a;
            --primary: #0a84ff;
            --primary-hover: #0071e3;
            --primary-glow: rgba(10, 132, 255, 0.15);
            --primary-soft: rgba(10, 132, 255, 0.1);
            --danger: #ff453a;
            --danger-soft: rgba(255, 69, 58, 0.15);
            --success: #30d158;
            --success-soft: rgba(48, 209, 88, 0.15);
            --text: #f5f5f7;
            --text-secondary: #98989d;
            --text-muted: #636366;
            --radius-sm: 10px;
            --radius: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --shadow: 0 4px 24px rgba(0,0,0,0.4);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.6);
            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            max-width: 520px;
            margin: 0 auto;
            padding: 12px;
            padding-top: calc(env(safe-area-inset-top, 0px) + 12px);
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
        }

        .header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 20px;
            padding: 18px;
            background: var(--surface);
            border-radius: var(--radius-xl);
        }

        .header-icon {
            width: 46px; height: 46px;
            background: linear-gradient(135deg, #0a84ff, #5e5ce6);
            border-radius: 13px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; color: white; flex-shrink: 0;
        }

        .header h1 { font-size: 1.4rem; font-weight: 700; letter-spacing: -0.3px; line-height: 1.2; }
        .header-sub { font-size: 0.82rem; color: var(--text-secondary); margin-top: 2px; }

        .card-group {
            background: var(--surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 6px;
        }

        .card {
            display: flex; align-items: center;
            padding: 14px 16px;
            cursor: pointer;
            transition: background var(--transition);
            min-height: 56px;
        }

        .card:active { background: var(--surface-2); }
        .card + .card { border-top: 0.5px solid var(--border); }

        .card-icon {
            width: 32px; height: 32px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.85rem; color: white; flex-shrink: 0; margin-right: 12px;
        }

        .card-icon.blue { background: #0a84ff; }
        .card-icon.orange { background: #ff9f0a; }
        .card-icon.green { background: #30d158; }
        .card-icon.purple { background: #bf5af2; }
        .card-icon.red { background: #ff453a; }

        .card-content { flex: 1; min-width: 0; }
        .card-title { font-size: 0.95rem; font-weight: 500; color: var(--text); line-height: 1.3; }

        .card-subtitle {
            font-size: 0.8rem; color: var(--text-secondary);
            margin-top: 2px; line-height: 1.3;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        .card-subtitle.has-tags {
            white-space: normal; display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;
        }

        .mini-tag {
            display: inline-flex; align-items: center; gap: 3px;
            background: var(--surface-2); padding: 2px 8px; border-radius: 20px;
            font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap;
        }

        .mini-tag .cnt {
            background: var(--primary-soft); color: var(--primary);
            font-weight: 700; padding: 0 5px; border-radius: 8px; font-size: 0.7rem;
        }

        .card-chevron { color: var(--text-muted); font-size: 0.75rem; margin-left: 8px; flex-shrink: 0; }

        /* SAVE BUTTON with sum */
        .footer-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 15px; border-radius: var(--radius); border: none;
            font-size: 0.95rem; font-weight: 600; cursor: pointer;
            text-align: center; transition: all var(--transition);
            display: flex; align-items: center; justify-content: center;
            gap: 8px; font-family: inherit;
        }

        .btn:active { transform: scale(0.97); }

        .btn-reset { background: var(--surface); color: var(--text-secondary); }
        .btn-reset:active { background: var(--surface-2); }

        .btn-submit { background: var(--primary); color: white; flex-direction: column; gap: 2px; }
        .btn-submit:active { background: var(--primary-hover); }

        .btn-submit-main {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.95rem; font-weight: 600;
        }

        .btn-submit-sum {
            font-size: 0.78rem; font-weight: 500; opacity: 0.8;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 1000;
            display: flex; align-items: flex-end; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--surface);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            width: 100%; max-width: 520px;
            max-height: 92vh; max-height: 92dvh;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .modal-overlay.active .modal { transform: translateY(0); }

        .modal-handle {
            width: 36px; height: 5px; background: var(--surface-3);
            border-radius: 3px; margin: 8px auto 0; flex-shrink: 0;
        }

        .modal-head {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 20px 10px; flex-shrink: 0;
        }

        .modal-head h2 {
            font-size: 1.15rem; font-weight: 700;
            display: flex; align-items: center; gap: 8px;
        }

        .modal-head h2 i { color: var(--primary); font-size: 1rem; }

        .modal-close-btn {
            width: 32px; height: 32px; border-radius: 50%; border: none;
            background: var(--surface-3); color: var(--text-secondary);
            font-size: 0.85rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all var(--transition);
        }

        .modal-close-btn:active { background: var(--border-hover); transform: scale(0.9); }

        .modal-body {
            flex: 1; overflow-y: auto; padding: 0 16px 16px;
            overscroll-behavior: contain; -webkit-overflow-scrolling: touch;
        }

        .modal-footer {
            padding: 10px 16px;
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
            border-top: 0.5px solid var(--border);
            flex-shrink: 0;
        }

        .modal-footer .btn-done {
            width: 100%; padding: 14px;
            background: var(--primary); color: white;
            border: none; border-radius: var(--radius);
            font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: all var(--transition);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        .modal-footer .btn-done:active { background: var(--primary-hover); transform: scale(0.98); }

        /* Modal footer with sum */
        .modal-footer-sum {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 4px 6px;
        }

        .modal-footer-sum-label {
            font-size: 0.82rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .modal-footer-sum-value {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--success);
        }

        .field { margin-bottom: 12px; }

        .field-label {
            font-size: 0.78rem; font-weight: 500; color: var(--text-secondary);
            margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.3px; padding-left: 4px;
        }

        .field-input {
            width: 100%; background: var(--surface-2); border: none;
            border-radius: var(--radius); padding: 13px 14px;
            font-size: 1rem; color: var(--text); outline: none;
            transition: box-shadow var(--transition); font-family: inherit;
        }

        .field-input:focus { box-shadow: 0 0 0 3px var(--primary-glow), inset 0 0 0 1px var(--primary); }
        .field-input::placeholder { color: var(--text-muted); }

        .mech-list {
            display: flex; flex-direction: column;
            background: var(--surface-2); border-radius: var(--radius); overflow: hidden;
        }

        .mech-item {
            display: flex; align-items: center; gap: 12px;
            padding: 13px 14px; cursor: pointer;
            transition: background var(--transition); user-select: none;
        }

        .mech-item + .mech-item { border-top: 0.5px solid var(--border); }
        .mech-item:active { background: var(--surface-3); }

        .mech-check {
            width: 24px; height: 24px; border-radius: 50%;
            border: 2px solid var(--text-muted);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; transition: all var(--transition);
            font-size: 0.65rem; color: transparent;
        }

        .mech-item.selected .mech-check {
            background: var(--primary); border-color: var(--primary); color: white;
        }

        .mech-name { font-weight: 500; font-size: 0.95rem; }

        .radius-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 6px; margin-bottom: 16px;
        }

        .radius-btn {
            padding: 12px 0; border-radius: var(--radius); border: none;
            background: var(--surface-2); color: var(--text);
            font-size: 1rem; font-weight: 600; cursor: pointer;
            text-align: center; transition: all var(--transition);
        }

        .radius-btn:active { transform: scale(0.94); }
        .radius-btn.active { background: var(--primary); color: white; }

        .type-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 6px; margin-bottom: 16px;
        }

        .type-btn {
            padding: 12px 10px; border-radius: var(--radius); border: none;
            background: var(--surface-2); color: var(--text-secondary);
            font-size: 0.85rem; font-weight: 600; cursor: pointer;
            text-align: center; transition: all var(--transition);
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }

        .type-btn:active { transform: scale(0.96); }
        .type-btn.active { background: var(--primary-soft); color: var(--primary); }
        .type-btn i { font-size: 0.9rem; }

        .qty-row {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--surface-2); border-radius: var(--radius);
            padding: 10px 14px; margin-bottom: 12px;
        }

        .qty-row-label {
            font-weight: 600; font-size: 0.9rem; color: var(--text);
            display: flex; align-items: center; gap: 8px;
        }

        .qty-row-label i { color: var(--primary); }

        .qty-stepper {
            display: flex; align-items: center;
            background: var(--surface-3); border-radius: 10px; overflow: hidden;
        }

        .qty-stepper button {
            width: 38px; height: 38px; border: none; background: transparent;
            color: var(--primary); font-size: 1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background var(--transition);
        }

        .qty-stepper button:active { background: var(--primary-soft); }

        .qty-stepper .qty-val {
            width: 40px; text-align: center;
            font-size: 1.1rem; font-weight: 700; color: var(--text);
        }

        .apply-all-bar {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 14px; background: var(--primary-soft);
            border-radius: var(--radius); cursor: pointer;
            transition: all var(--transition);
        }

        .apply-all-bar:active { transform: scale(0.98); opacity: 0.8; }
        .apply-all-bar i { color: var(--primary); font-size: 1rem; }
        .apply-all-bar span { font-weight: 600; font-size: 0.9rem; color: var(--primary); }

        .items-list {
            display: flex; flex-direction: column;
            background: var(--surface-2); border-radius: var(--radius); overflow: hidden;
        }

        .item-row {
            display: flex; align-items: center;
            padding: 10px 14px; transition: opacity var(--transition); gap: 10px;
        }

        .item-row + .item-row { border-top: 0.5px solid var(--border); }
        .item-row.zero { opacity: 0.3; }

        .item-name-block { flex: 1; min-width: 0; }

        .item-name {
            font-weight: 500; font-size: 0.88rem; color: var(--text);
            line-height: 1.3;
        }

        .item-price-label {
            font-size: 0.75rem; color: var(--text-muted); margin-top: 1px;
        }

        .item-controls {
            display: flex; align-items: center; gap: 8px; flex-shrink: 0;
        }

        .item-select-wrap { position: relative; flex-shrink: 0; }

        .item-select {
            appearance: none; -webkit-appearance: none;
            background: var(--surface-3); color: var(--primary);
            border: none; border-radius: 8px;
            padding: 6px 28px 6px 10px;
            font-size: 0.95rem; font-weight: 700; font-family: inherit;
            cursor: pointer; outline: none; min-width: 58px; text-align: center;
        }

        .item-select:focus { box-shadow: 0 0 0 2px var(--primary-glow); }

        .item-select-arrow {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            font-size: 0.6rem; color: var(--text-muted); pointer-events: none;
        }

        .item-delete {
            width: 32px; height: 32px; border: none; background: transparent;
            color: var(--text-muted); font-size: 0.8rem; cursor: pointer;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; transition: all var(--transition);
        }

        .item-delete:active { color: var(--danger); background: var(--danger-soft); }

        .toast {
            position: fixed;
            top: calc(env(safe-area-inset-top, 0px) + 16px);
            left: 50%; transform: translateX(-50%) translateY(-80px);
            background: var(--surface-2); color: var(--text);
            padding: 13px 22px; border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg); z-index: 2000; opacity: 0;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; align-items: center; gap: 10px;
            font-weight: 600; font-size: 0.9rem; white-space: nowrap;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 0.5px solid var(--border);
        }

        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast i { color: var(--success); }

        .confirm-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 3000;
            display: flex; align-items: center; justify-content: center;
            padding: 40px; opacity: 0; visibility: hidden;
            transition: all 0.25s ease;
        }

        .confirm-overlay.active { opacity: 1; visibility: visible; }

        .confirm-dialog {
            background: var(--surface-2); border-radius: 14px;
            width: 100%; max-width: 300px; text-align: center;
            overflow: hidden; transform: scale(0.9);
            transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .confirm-overlay.active .confirm-dialog { transform: scale(1); }

        .confirm-body { padding: 22px 20px 16px; }
        .confirm-title { font-size: 1.05rem; font-weight: 700; margin-bottom: 8px; }
        .confirm-text { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4; white-space: pre-line; }

        .confirm-actions { border-top: 0.5px solid var(--border); display: flex; }

        .confirm-actions button {
            flex: 1; padding: 14px; border: none; background: transparent;
            font-size: 1rem; font-family: inherit; cursor: pointer;
            transition: background var(--transition);
        }

        .confirm-actions button:active { background: var(--surface-3); }
        .confirm-actions .confirm-cancel { color: var(--primary); font-weight: 400; border-right: 0.5px solid var(--border); }
        .confirm-actions .confirm-ok { color: var(--primary); font-weight: 700; }

        .modal-body::-webkit-scrollbar { width: 0; }

        @media (min-width: 520px) {
            .modal { border-radius: var(--radius-xl); margin: auto; max-height: 85vh; }
            .modal-overlay { align-items: center; padding: 20px; }
            .modal-footer { padding-bottom: 16px; }
        }

        @media (max-width: 380px) {
            .radius-grid { grid-template-columns: repeat(3, 1fr); }
            .header h1 { font-size: 1.25rem; }
            .item-name { font-size: 0.82rem; }
        }
    </style>
</head>
<body>

<div class="app">
    <div class="header">
        <div class="header-icon"><i class="fa-solid fa-gear"></i></div>
        <div>
            <h1>Шиномонтаж</h1>
            <div class="header-sub">Оформление заказа</div>
        </div>
    </div>

    <div class="card-group">
        <div class="card" data-modal="mechanics">
            <div class="card-icon blue"><i class="fa-solid fa-users"></i></div>
            <div class="card-content">
                <div class="card-title">Механики</div>
                <div class="card-subtitle" id="dMechanics">Выберите механиков</div>
            </div>
            <span class="card-chevron"><i class="fa-solid fa-chevron-right"></i></span>
        </div>
        <div class="card" data-modal="client">
            <div class="card-icon orange"><i class="fa-solid fa-user"></i></div>
            <div class="card-content">
                <div class="card-title">Клиент</div>
                <div class="card-subtitle" id="dClient">Добавить информацию</div>
            </div>
            <span class="card-chevron"><i class="fa-solid fa-chevron-right"></i></span>
        </div>
    </div>

    <div class="card-group">
        <div class="card" data-modal="wheels">
            <div class="card-icon green"><i class="fa-solid fa-circle-dot"></i></div>
            <div class="card-content">
                <div class="card-title">Параметры колёс</div>
                <div class="card-subtitle" id="dWheels">Не выбраны</div>
            </div>
            <span class="card-chevron"><i class="fa-solid fa-chevron-right"></i></span>
        </div>
    </div>

    <div class="card-group">
        <div class="card" data-modal="materials">
            <div class="card-icon purple"><i class="fa-solid fa-box-open"></i></div>
            <div class="card-content">
                <div class="card-title">Материалы</div>
                <div class="card-subtitle" id="dMaterials">Нет позиций</div>
            </div>
            <span class="card-chevron"><i class="fa-solid fa-chevron-right"></i></span>
        </div>
        <div class="card" data-modal="services">
            <div class="card-icon red"><i class="fa-solid fa-wrench"></i></div>
            <div class="card-content">
                <div class="card-title">Услуги</div>
                <div class="card-subtitle" id="dServices">Нет позиций</div>
            </div>
            <span class="card-chevron"><i class="fa-solid fa-chevron-right"></i></span>
        </div>
    </div>

    <div class="footer-actions">
        <button class="btn btn-reset" id="btnReset"><i class="fa-solid fa-rotate-left"></i> Сбросить</button>
        <button class="btn btn-submit" id="btnSave">
            <span class="btn-submit-main"><i class="fa-solid fa-check"></i> Сохранить</span>
            <span class="btn-submit-sum" id="btnSaveSum"></span>
        </button>
    </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="mMechanics">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-head">
            <h2><i class="fa-solid fa-users"></i> Механики</h2>
            <button class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <div class="mech-list" id="mechList"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-done"><i class="fa-solid fa-check"></i> Готово</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="mClient">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-head">
            <h2><i class="fa-solid fa-user"></i> Клиент</h2>
            <button class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <div class="field">
                <div class="field-label">ФИО</div>
                <input class="field-input" id="inName" type="text" placeholder="Иванов Иван Иванович" autocomplete="name">
            </div>
            <div class="field">
                <div class="field-label">Телефон</div>
                <input class="field-input" id="inPhone" type="tel" placeholder="+7 (999) 123-45-67" autocomplete="tel">
            </div>
            <div class="field">
                <div class="field-label">Автомобиль</div>
                <input class="field-input" id="inCar" type="text" placeholder="Toyota Camry, А123БВ">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-done"><i class="fa-solid fa-check"></i> Готово</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="mWheels">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-head">
            <h2><i class="fa-solid fa-circle-dot"></i> Колёса</h2>
            <button class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <div class="field-label">Радиус</div>
            <div class="radius-grid" id="radiusGrid"></div>

            <div class="field-label">Тип</div>
            <div class="type-grid" id="typeGrid">
                <div class="type-btn" data-type="light"><i class="fa-solid fa-car"></i> Легковая</div>
                <div class="type-btn" data-type="jeep"><i class="fa-solid fa-truck-monster"></i> Джип</div>
                <div class="type-btn" data-type="lowProfile"><i class="fa-solid fa-bolt"></i> Низкий профиль</div>
                <div class="type-btn" data-type="runflat"><i class="fa-solid fa-shield-halved"></i> RunFlat</div>
            </div>

            <div class="qty-row">
                <div class="qty-row-label"><i class="fa-solid fa-layer-group"></i> Количество</div>
                <div class="qty-stepper">
                    <button id="wQtyMinus"><i class="fa-solid fa-minus"></i></button>
                    <span class="qty-val" id="wQtyVal">4</span>
                    <button id="wQtyPlus"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>

            <div class="apply-all-bar" id="applyAll">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <span>Применить ко всем позициям</span>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-done"><i class="fa-solid fa-check"></i> Готово</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="mMaterials">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-head">
            <h2><i class="fa-solid fa-box-open"></i> Материалы</h2>
            <button class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <div class="items-list" id="matList"></div>
        </div>
        <div class="modal-footer">
            <div class="modal-footer-sum" id="matFooterSum"></div>
            <button class="btn-done"><i class="fa-solid fa-check"></i> Готово</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="mServices">
    <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-head">
            <h2><i class="fa-solid fa-wrench"></i> Услуги</h2>
            <button class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <div class="items-list" id="svcList"></div>
        </div>
        <div class="modal-footer">
            <div class="modal-footer-sum" id="svcFooterSum"></div>
            <button class="btn-done"><i class="fa-solid fa-check"></i> Готово</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"><i class="fa-solid fa-circle-check"></i> <span id="toastMsg"></span></div>

<div class="confirm-overlay" id="confirmOverlay">
    <div class="confirm-dialog">
        <div class="confirm-body">
            <div class="confirm-title" id="confirmTitle"></div>
            <div class="confirm-text" id="confirmText"></div>
        </div>
        <div class="confirm-actions">
            <button class="confirm-cancel" id="confirmCancel">Отмена</button>
            <button class="confirm-ok" id="confirmOk">OK</button>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';

    const MECHANICS = [
        'Андреев Андрей','Борисов Борис','Власов Владислав','Григорьев Григорий',
        'Дмитриев Дмитрий','Егоров Егор','Жуков Жорж','Зайцев Захар'
    ];

    const MATERIALS = [
        {id:1, name:'Расходные материалы',   price: 150},
        {id:2, name:'Грузик набивной',       price: 50},
        {id:3, name:'Грузик самоклеющийся',  price: 80},
        {id:4, name:'Вентиль простой',       price: 100},
        {id:5, name:'Вентиль хром',          price: 250},
        {id:6, name:'Жгут',                  price: 200}
    ];

    const SERVICES = [
        {id:1,  name:'Съём и установка колеса',    price: 300},
        {id:2,  name:'Демонтаж шины',              price: 250},
        {id:3,  name:'Монтаж шины',                price: 250},
        {id:4,  name:'Балансировка',                price: 350},
        {id:5,  name:'Технологическая мойка',       price: 200},
        {id:6,  name:'Сложность с датчиком',       price: 500},
        {id:7,  name:'Обработка ступицы',          price: 150},
        {id:8,  name:'Шиноремонт жгутом',          price: 400},
        {id:9,  name:'Съём и установка камеры',    price: 350},
        {id:10, name:'Погрузка колеса в сборе',    price: 100}
    ];

    const RADII = [13,14,15,16,17,18,19,20,21,22,23,24];

    let state = getDefaultState();

    function getDefaultState() {
        return {
            mechanics: [],
            client: {name:'',phone:'',car:''},
            wheels: {radius:17, types:{light:false,jeep:false,lowProfile:false,runflat:false}, qty:4},
            materials: MATERIALS.map(m=>({...m, qty:1})),
            services: SERVICES.map(s=>({...s, qty:1}))
        };
    }

    function fmtPrice(n) {
        return n.toLocaleString('ru-RU') + ' ₽';
    }

    function calcTotal() {
        let sum = 0;
        state.materials.forEach(i => { if (i.qty > 0) sum += i.price * i.qty; });
        state.services.forEach(i => { if (i.qty > 0) sum += i.price * i.qty; });
        return sum;
    }

    function calcItemsSum(items) {
        let sum = 0;
        items.forEach(i => { if (i.qty > 0) sum += i.price * i.qty; });
        return sum;
    }

    function updateSaveBtn() {
        const sum = calcTotal();
        const el = document.getElementById('btnSaveSum');
        el.textContent = sum > 0 ? fmtPrice(sum) : '';
    }

    function updateModalFooterSum(footerId, items) {
        const el = document.getElementById(footerId);
        if (!el) return;
        const sum = calcItemsSum(items);
        if (sum > 0) {
            el.innerHTML = `<span class="modal-footer-sum-label">Сумма:</span><span class="modal-footer-sum-value">${fmtPrice(sum)}</span>`;
        } else {
            el.innerHTML = '';
        }
    }

    function updateAll() {
        updateMechanicsDisp();
        updateClientDisp();
        updateWheelsDisp();
        updateItemsDisp('dMaterials', state.materials, 'Нет позиций');
        updateItemsDisp('dServices', state.services, 'Нет позиций');
        updateSaveBtn();
    }

    function updateMechanicsDisp() {
        const el = document.getElementById('dMechanics');
        if (!state.mechanics.length) {
            el.className = 'card-subtitle';
            el.textContent = 'Выберите механиков';
        } else {
            el.className = 'card-subtitle has-tags';
            el.innerHTML = state.mechanics.map(n=>`<span class="mini-tag"><i class="fa-solid fa-user-gear" style="font-size:0.65rem;color:var(--primary)"></i> ${n}</span>`).join('');
        }
    }

    function updateClientDisp() {
        const el = document.getElementById('dClient');
        const c = state.client;
        el.className = 'card-subtitle';
        if (!c.name && !c.phone && !c.car) {
            el.textContent = 'Добавить информацию';
        } else {
            let parts = [];
            if (c.name) parts.push(c.name);
            if (c.phone) parts.push(c.phone);
            if (c.car) parts.push(c.car);
            el.textContent = parts.join(' · ');
        }
    }

    function updateWheelsDisp() {
        const el = document.getElementById('dWheels');
        const w = state.wheels;
        el.className = 'card-subtitle has-tags';
        let tags = [`<span class="mini-tag" style="font-weight:700;color:var(--text)">R${w.radius}</span>`];
        const typeLabels = {light:'Легковая',jeep:'Джип',lowProfile:'Низкий профиль',runflat:'RunFlat'};
        for (let k in w.types) {
            if (w.types[k]) tags.push(`<span class="mini-tag">${typeLabels[k]}</span>`);
        }
        tags.push(`<span class="mini-tag"><span class="cnt">${w.qty}</span> шт</span>`);
        el.innerHTML = tags.join('');
    }

    function updateItemsDisp(elId, items, emptyText) {
        const el = document.getElementById(elId);
        const active = items.filter(i=>i.qty>0);
        if (!active.length) {
            el.className = 'card-subtitle';
            el.textContent = emptyText;
        } else {
            el.className = 'card-subtitle has-tags';
            el.innerHTML = active.map(i => {
                let n = i.name.length > 16 ? i.name.substring(0,14)+'…' : i.name;
                return `<span class="mini-tag">${n}<span class="cnt">${i.qty}</span></span>`;
            }).join('');
        }
    }

    const modalMap = {
        mechanics: 'mMechanics',
        client: 'mClient',
        wheels: 'mWheels',
        materials: 'mMaterials',
        services: 'mServices'
    };

    function openModal(name) {
        const id = modalMap[name];
        if (!id) return;
        if (name === 'mechanics') buildMechanicsModal();
        if (name === 'client') fillClientModal();
        if (name === 'wheels') buildWheelsModal();
        if (name === 'materials') { buildItemsModal('matList', state.materials); updateModalFooterSum('matFooterSum', state.materials); }
        if (name === 'services') { buildItemsModal('svcList', state.services); updateModalFooterSum('svcFooterSum', state.services); }

        document.getElementById(id).classList.add('active');
        document.body.style.overflow = 'hidden';

        if (name === 'client') {
            setTimeout(() => document.getElementById('inName').focus(), 400);
        }
    }

    function closeModal(overlay) {
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    function buildMechanicsModal() {
        const el = document.getElementById('mechList');
        el.innerHTML = MECHANICS.map(name => {
            const sel = state.mechanics.includes(name);
            return `<div class="mech-item${sel?' selected':''}" data-name="${name}">
                <div class="mech-check"><i class="fa-solid fa-check"></i></div>
                <span class="mech-name">${name}</span>
            </div>`;
        }).join('');
    }

    function saveMechanics() {
        state.mechanics = [...document.querySelectorAll('#mechList .mech-item.selected')].map(el=>el.dataset.name);
        updateMechanicsDisp();
    }

    function fillClientModal() {
        document.getElementById('inName').value = state.client.name;
        document.getElementById('inPhone').value = state.client.phone;
        document.getElementById('inCar').value = state.client.car;
    }

    function saveClient() {
        state.client.name = document.getElementById('inName').value.trim();
        state.client.phone = document.getElementById('inPhone').value.trim();
        state.client.car = document.getElementById('inCar').value.trim();
        updateClientDisp();
    }

    function buildWheelsModal() {
        const grid = document.getElementById('radiusGrid');
        grid.innerHTML = RADII.map(r => `<div class="radius-btn${r===state.wheels.radius?' active':''}" data-r="${r}">R${r}</div>`).join('');
        document.querySelectorAll('#typeGrid .type-btn').forEach(btn => {
            btn.classList.toggle('active', state.wheels.types[btn.dataset.type]);
        });
        document.getElementById('wQtyVal').textContent = state.wheels.qty;
    }

    function saveWheels() {
        const activeR = document.querySelector('#radiusGrid .radius-btn.active');
        if (activeR) state.wheels.radius = parseInt(activeR.dataset.r);
        document.querySelectorAll('#typeGrid .type-btn').forEach(btn => {
            state.wheels.types[btn.dataset.type] = btn.classList.contains('active');
        });
        state.wheels.qty = parseInt(document.getElementById('wQtyVal').textContent);
        updateWheelsDisp();
    }

    function buildSelectOptions(currentQty) {
        let opts = '';
        for (let i = 0; i <= 20; i++) {
            opts += `<option value="${i}"${i === currentQty ? ' selected' : ''}>${i}</option>`;
        }
        return opts;
    }

    function buildItemsModal(listId, items) {
        const el = document.getElementById(listId);
        el.innerHTML = items.map((item, idx) => `
            <div class="item-row${item.qty===0?' zero':''}" data-idx="${idx}">
                <div class="item-name-block">
                    <div class="item-name">${item.name}</div>
                    <div class="item-price-label">${fmtPrice(item.price)} / шт</div>
                </div>
                <div class="item-controls">
                    <div class="item-select-wrap">
                        <select class="item-select" data-idx="${idx}">
                            ${buildSelectOptions(item.qty)}
                        </select>
                        <span class="item-select-arrow"><i class="fa-solid fa-chevron-down"></i></span>
                    </div>
                    <button class="item-delete" data-idx="${idx}"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            </div>
        `).join('');
    }

    function saveItems(listId, items) {
        document.querySelectorAll(`#${listId} .item-row`).forEach(row => {
            const idx = parseInt(row.dataset.idx);
            items[idx].qty = parseInt(row.querySelector('.item-select').value);
        });
    }

    function formatPhone(val) {
        let d = val.replace(/\D/g, '');
        if (d.startsWith('8') && d.length > 1) d = '7' + d.substring(1);
        if (!d.startsWith('7') && d.length > 0) d = '7' + d;
        let out = '';
        if (d.length > 0) out = '+' + d[0];
        if (d.length > 1) out += ' (' + d.substring(1, Math.min(4, d.length));
        if (d.length >= 4) out += ') ';
        if (d.length > 4) out += d.substring(4, Math.min(7, d.length));
        if (d.length > 7) out += '-' + d.substring(7, Math.min(9, d.length));
        if (d.length > 9) out += '-' + d.substring(9, Math.min(11, d.length));
        return out;
    }

    let toastTimer;
    function showToast(msg) {
        const t = document.getElementById('toast');
        document.getElementById('toastMsg').textContent = msg;
        t.classList.add('show');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
    }

    function showConfirm(title, text) {
        return new Promise(resolve => {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmText').textContent = text;
            const overlay = document.getElementById('confirmOverlay');
            overlay.classList.add('active');
            const onOk = () => { cleanup(); resolve(true); };
            const onCancel = () => { cleanup(); resolve(false); };
            const onBg = (e) => { if (e.target === overlay) { cleanup(); resolve(false); } };
            function cleanup() {
                overlay.classList.remove('active');
                document.getElementById('confirmOk').removeEventListener('click', onOk);
                document.getElementById('confirmCancel').removeEventListener('click', onCancel);
                overlay.removeEventListener('click', onBg);
            }
            document.getElementById('confirmOk').addEventListener('click', onOk);
            document.getElementById('confirmCancel').addEventListener('click', onCancel);
            overlay.addEventListener('click', onBg);
        });
    }

    function init() {
        document.querySelectorAll('.card[data-modal]').forEach(card => {
            card.addEventListener('click', () => openModal(card.dataset.modal));
        });

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', e => {
                if (e.target === overlay) { saveCurrentModal(overlay); closeModal(overlay); }
            });
        });

        document.querySelectorAll('.modal-close-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const overlay = btn.closest('.modal-overlay');
                saveCurrentModal(overlay); closeModal(overlay);
            });
        });

        document.querySelectorAll('.modal-footer .btn-done').forEach(btn => {
            btn.addEventListener('click', () => {
                const overlay = btn.closest('.modal-overlay');
                saveCurrentModal(overlay); closeModal(overlay);
                showToast('Сохранено');
            });
        });

        document.getElementById('mechList').addEventListener('click', e => {
            const item = e.target.closest('.mech-item');
            if (item) item.classList.toggle('selected');
        });

        document.getElementById('inPhone').addEventListener('input', function() {
            const pos = this.selectionStart;
            const before = this.value.length;
            this.value = formatPhone(this.value);
            const after = this.value.length;
            this.setSelectionRange(pos + (after - before), pos + (after - before));
        });

        document.getElementById('radiusGrid').addEventListener('click', e => {
            const btn = e.target.closest('.radius-btn');
            if (!btn) return;
            document.querySelectorAll('#radiusGrid .radius-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });

        document.getElementById('typeGrid').addEventListener('click', e => {
            const btn = e.target.closest('.type-btn');
            if (!btn) return;
            const type = btn.dataset.type;
            if (type === 'light' || type === 'jeep') {
                const other = document.querySelector(`#typeGrid .type-btn[data-type="${type === 'light' ? 'jeep' : 'light'}"]`);
                if (btn.classList.contains('active')) { btn.classList.remove('active'); }
                else { btn.classList.add('active'); other.classList.remove('active'); }
            } else { btn.classList.toggle('active'); }
        });

        document.getElementById('wQtyMinus').addEventListener('click', () => {
            const el = document.getElementById('wQtyVal');
            let v = parseInt(el.textContent);
            if (v > 1) el.textContent = --v;
        });
        document.getElementById('wQtyPlus').addEventListener('click', () => {
            const el = document.getElementById('wQtyVal');
            let v = parseInt(el.textContent);
            if (v < 20) el.textContent = ++v;
        });

        document.getElementById('applyAll').addEventListener('click', () => {
            const qty = parseInt(document.getElementById('wQtyVal').textContent);
            state.materials.forEach(m => m.qty = qty);
            state.services.forEach(s => s.qty = qty);
            buildItemsModal('matList', state.materials);
            buildItemsModal('svcList', state.services);
            updateItemsDisp('dMaterials', state.materials, 'Нет позиций');
            updateItemsDisp('dServices', state.services, 'Нет позиций');
            updateSaveBtn();
            showToast(`Количество ${qty} применено`);
        });

        // Items — select change & delete with live footer sum update
        ['matList','svcList'].forEach(listId => {
            const items = listId === 'matList' ? state.materials : state.services;
            const footerId = listId === 'matList' ? 'matFooterSum' : 'svcFooterSum';

            document.getElementById(listId).addEventListener('change', e => {
                if (e.target.classList.contains('item-select')) {
                    const idx = parseInt(e.target.dataset.idx);
                    items[idx].qty = parseInt(e.target.value);
                    e.target.closest('.item-row').classList.toggle('zero', items[idx].qty === 0);
                    updateModalFooterSum(footerId, items);
                }
            });
            document.getElementById(listId).addEventListener('click', e => {
                if (e.target.closest('.item-delete')) {
                    const idx = parseInt(e.target.closest('.item-delete').dataset.idx);
                    const row = e.target.closest('.item-row');
                    items[idx].qty = 0;
                    row.querySelector('.item-select').value = '0';
                    row.classList.add('zero');
                    updateModalFooterSum(footerId, items);
                }
            });
        });

        document.getElementById('btnReset').addEventListener('click', async () => {
            const ok = await showConfirm('Сбросить форму?', 'Все введённые данные будут удалены.');
            if (ok) { state = getDefaultState(); updateAll(); showToast('Форма сброшена'); }
        });

        document.getElementById('btnSave').addEventListener('click', async () => {
            const mech = state.mechanics.length ? state.mechanics.join(', ') : 'не выбраны';
            const cl = state.client;
            const clParts = [cl.name||'—', cl.phone||'—', cl.car||'—'].join(', ');
            const matActive = state.materials.filter(m=>m.qty>0);
            const svcActive = state.services.filter(s=>s.qty>0);
            const types = Object.entries(state.wheels.types).filter(([,v])=>v).map(([k])=>({light:'Легковая',jeep:'Джип',lowProfile:'Низкий профиль',runflat:'RunFlat'}[k]));
            const totalSum = calcTotal();

            const summaryText = `Механики: ${mech}\nКлиент: ${clParts}\nКолёса: R${state.wheels.radius}, ${types.join(', ')||'без типа'}, ${state.wheels.qty} шт\nМатериалы: ${matActive.length} поз.\nУслуги: ${svcActive.length} поз.\n\nСумма: ${fmtPrice(totalSum)}`;

            const ok = await showConfirm('Сохранить заказ?', summaryText);
            if (ok) {
                console.log('ORDER:', JSON.stringify(state, null, 2));
                showToast('Заказ сохранён');
            }
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.target.closest('button') && !e.target.closest('select')) {
                const active = document.querySelector('.modal-overlay.active');
                if (active) { e.preventDefault(); saveCurrentModal(active); closeModal(active); showToast('Сохранено'); }
            }
        });

        let touchStartY = 0;
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('touchstart', e => { touchStartY = e.touches[0].clientY; }, {passive: true});
            modal.addEventListener('touchend', e => {
                const dy = e.changedTouches[0].clientY - touchStartY;
                const body = modal.querySelector('.modal-body');
                if (dy > 80 && (!body || body.scrollTop <= 0)) {
                    const overlay = modal.closest('.modal-overlay');
                    saveCurrentModal(overlay); closeModal(overlay);
                }
            }, {passive: true});
        });

        updateAll();
    }

    function saveCurrentModal(overlay) {
        const id = overlay.id;
        if (id === 'mMechanics') saveMechanics();
        else if (id === 'mClient') saveClient();
        else if (id === 'mWheels') saveWheels();
        else if (id === 'mMaterials') { saveItems('matList', state.materials); updateItemsDisp('dMaterials', state.materials, 'Нет позиций'); }
        else if (id === 'mServices') { saveItems('svcList', state.services); updateItemsDisp('dServices', state.services, 'Нет позиций'); }
        updateSaveBtn();
    }

    init();
})();
</script>
</body>
</html>